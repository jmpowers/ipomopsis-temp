---
title: "Ipomopsis temperature experiments: Volatiles"
author: "Carrie Wu, John Powers, David Hopp, Diane Campbell"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: no
    lib_dir: libs
    code_folding: hide
    toc: yes
    toc_float: TRUE 
editor_options: 
  chunk_output_type: console
---
<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>

```{r setup, include=FALSE}
library(reshape2)
library(tidyverse)
library(lubridate)
library(bouquet)
library(vegan)
library(broom)
library(viridis)
library(RColorBrewer)
library(pheatmap)
library(dendsort)
library(knitr)
knitr::opts_chunk$set(comment="", cache=T, warning=F, message=F, 
                      fig.path = "plots/", dev="svglite", dev.args=list(fix_text_size=FALSE), fig.height=8, fig.width=8)
```

```{r read_shimadzu, eval=F}
# CWu GC data
# setwd("~/MyDocs/MEGA/UCI/Schiedea/Analysis/scent/rmbl/CWu")
# source("read_shimadzu.R")
# setwd("/media/C/GCMSsolution/Data/heather Ipo/")
# data18 <- read.shimadzu("./Temperature expt CWu 2018/CWu2018.txt")
# data19 <- read.shimadzu("./Temperature expt CWu 2019/CWu2019.txt")
# ipo.data <- rbind(data18, data19)
# 
# files.2021 <- c("Ihyb_VF_210718.txt", "Ihyb_VF_210719.txt", "Samples_210720.txt", 
#  "Ihyb_Corydalis_210728.txt", "Ihyb_Corydalis_210729.txt", "Ihyb_Corydalis_210730.txt", "Ihyb_Corydalis_210731.txt", "Maxfield_SC_210802b.txt",  
# "Maxfield_SC_210803.txt",    "SC_GNA_210804.txt",  "Lupinus20_SC_Lagg21_210814.txt" ,"SC_210817.txt", "SC_210818.txt",     
# "SC_210818b.txt",     "SC_210818b001.txt",  "SC_210820b.txt",     "SC_Lagg_210821.txt"  )
# 
# setwd("~/MyDocs/MEGA/UCI/Schiedea/Analysis/scent/rmbl/RMBL Batches")
# ipo.data.2021 <- map_dfr(files.2021, read.shimadzu)
# ipo.data <- rbind(ipo.data, ipo.data.2021)
# save(ipo.data, file="CWu_181921.Rdata")

# Maxfield GC data
# setwd("~/Downloads/MaxfieldVols21/batches")
# source("../read_shimadzu.R")
# datafiles <- list.files(pattern=".txt") # TODO had to copy over newer Maxfield_210802.txt and add Maxfield_SC_210802b.txt
# GCMS_output <- map(datafiles, read.shimadzu)
# filenames <- set_names(GCMS_output,datafiles) %>% bind_rows(.id="Batch") %>% as_tibble %>% 
#   group_by(Batch, Filename) %>% tally
# setwd("~/Downloads/MaxfieldVols21/")#"data" folder
# write_csv(filenames, "filenames.csv")
#... load in GCMS_metadata 
#GCMS_Maxfield_21 <- GCMS_output %>% bind_rows() %>% filter(Filename %in% GCMS_metadata$Filename)
#save(GCMS_Maxfield_21, file="Maxfield_21.Rdata")
```

```{r read_scents}
load("data/volatiles/Maxfield_21.Rdata") #GCMS_Maxfield_21 output from david_gcms_ipomopsis (3).R
load("data/volatiles/CWu_181921.Rdata")
#write(rownames(ipo.all), "data/volatiles/CWu_samples.txt")
ipos <- read.csv("data/volatiles/CWu_samples.csv", colClasses=list(RunDate="Date"))
ipo.data <- bind_rows(ipo.data, GCMS_Maxfield_21)

# load short names and standard regessions
ipochems <- read_csv("data/volatiles/Ipo volatile compounds - chemsf_ipo.csv") %>% 
  select(name, shortname, standard, verdict) %>%  filter(verdict != "") %>% 
  mutate(standard = fct_recode(standard, "Methyl_salicylate"="Benzaldehyde"), # benzaldehyde regressions not reliable
         class = fct_recode(standard, Aliphatic="Hexenol", Benzenoid="Methyl_salicylate", Benzenoid="Indole", 
                            Sesquiterpene="Caryophyllene", Monoterpene="alpha_Pinene", Monoterpene="Linalool")) %>%  
  left_join(read_csv("data/volatiles/regressions_181921_filtered_slopes.csv") %>% 
              pivot_wider(id_cols=standard, names_from="year", names_prefix="area_per_ng", values_from=area_per_ng)) 
class_pal <- set_names(c("#BC0060","#027B8C","#E56E00","#86D400"), levels(ipochems$class))

#shorten chemical names and merge compounds with multiple names
shortnames <- ipochems %>% select(name, shortname) %>% filter(shortname!="") %>% deframe()
#shortnames[shortnames %in% shortnames[duplicated(shortnames)]]
ipo.data$Name <- recode(ipo.data$Name, !!!shortnames)

ipo.all <- dcast(ipo.data, Filename~Name, sum, value.var="Area")
rownames(ipo.all) <- ipo.all[,1]
ipo.all[,1] <- NULL
```

# Overview - no metadata
## Inventory
```{r inventory, eval=FALSE}
#TODO merge F, G, H, I, J into GNA for 2018
with(ipos, table(Year, Type))
with(ipos, table(Type, DNLeaf))
```

## NMDS
```{r nmds, eval=FALSE}
ipo.cut <- ipo.all[,colSums(ipo.all)>1e9]
set.seed(1)
nmds.ipo <- metaMDS(decostand(ipo.cut, "hellinger"), dist="bray", autotransform = FALSE, try=5, trymax=5)

par(bg="grey40")
ordiplot(nmds.ipo, type = "n")
ipos$rs <- rowSums(ipo.all)
ipos$nameBlank <- ipos$Type %in% c("Blank","Bake")
ipos$nameAir <- ipos$Type == "Air"
thisyear <- ipos$Year == 2019
#with(ipos, points(nmds.ipo, display="sites", col=viridis(200)[round(200*sqrt(rs/max(rs)))], pch=as.integer(isblank)+1))
with(ipos, points(nmds.ipo, display="sites", col=rainbow(nlevels(ipos$Type))[ipos$Type], pch=as.integer(nameAir*2+nameBlank)+1))
#with(ipos, points(nmds.ipo, display="sites", col=rainbow(nlevels(ipos$Type))[ipos$Type], pch=ipos$Year-2017))
legend("topright", legend=levels(ipos$Type), fill=rainbow(nlevels(ipos$Type)), cex=0.8)
```

## Kmeans clustering
```{r kmeans, eval=FALSE}
k <- 8
set.seed(1)
km <- kmeans(decostand(ipo.cut, "log"), k, nstart=3)
ipos$Cluster <- km$cluster
ipos$kBlank <- kblank <- km$cluster %in% c(4)
ipos$Mixup <- ipos$nameBlank != ipos$kBlank
with(ipos, table(kBlank, nameBlank))

ordiplot(nmds.ipo, type = "n")
points(nmds.ipo, display="sites", col=ifelse(kblank, "black", rainbow(k)[km$cluster]), pch=with(ipos,as.integer(nameAir*2+nameBlank))+1) 
text(nmds.ipo, display="species",col="grey80",labels=ifelse(colSums(ipo.cut)>4e8, colnames(ipo.cut), ""))
text(nmds.ipo, display="sites", col=with(ipos, as.integer(thisyear)*4+as.integer(nameBlank)*2+as.integer(nameAir)+1), labels=as.character(km$cluster))
```


## CAP - blanks and years
```{r cap_blankyear, eval=FALSE}
ipo.cap <- capscale(ipo.cut ~ as.factor(ipos$kBlank) * as.factor(thisyear), distance="bray", metaMDSdist = F)
plot(ipo.cap, type="n")
points(ipo.cap, display="sites", col=ifelse(ipos$kBlank, "black", rainbow(k)[ipos$Cluster]), pch=as.integer(ipos$nameAir*2+ipos$nameBlank)+1) 
#View(ipo.cap$CCA$v)
```

## CAP - DNLeaf
```{r cap_DNLeaf, eval=FALSE}
dnl <- ipos$DNLeaf!="" & ipos$Type !="Air"
ipo.cap.dnl <- capscale(ipo.cut[dnl,] ~ ipos[dnl,"DNLeaf"], distance="bray", metaMDSdist = F)
plot(ipo.cap.dnl, type="n")
points(ipo.cap.dnl, display="sites", pch=as.integer(ipos[dnl,"DNLeaf"])-1, col=as.integer(factor(ipos[dnl,"Type"]))) 
legend("bottomleft", levels(factor(ipos[dnl,"Type"])), fill=1:nlevels(ipos$Type), cex=0.8)
legend("left", levels(ipos[dnl,"DNLeaf"]), pch=1:nlevels(ipos[dnl,"DNLeaf"])-1, cex=0.8)
#View(ipo.cap.dnl$CCA$v)
```

# Read metadata
```{r metadata}
files <- read_tsv("data/volatiles/CWu_samples_text2.csv") %>% 
  rename(temp=OI) %>% mutate(temp = recode(temp,"in"="warmed","out"="control"))
perc <- read_csv("data/volatiles/CWu Ipomopsis Scent Metadata - Percivals2018_2019.csv")
otc <- read_csv("data/volatiles/CWu Ipomopsis Scent Metadata - OTC2018_2019.csv")  %>%  
  rename(temp=OI) %>% mutate(temp = recode(temp,"in"="warmed","out"="control"))

sc21 <- read_tsv("data/volatiles/2021 Spring Creek Volatiles - 2021.tsv") %>% 
  mutate(PlantType=if_else(plant=="air", "air", "ten"))
gna21 <- read_tsv("data/volatiles/2021 GNA Volatiles - 2021.tsv") %>% 
  mutate(time="day", PlantType=if_else(plant=="air", "air", "agg"))

files21 <- tibble(Filename = rownames(ipo.all)) %>% 
  filter(str_detect(Filename, "2021"), 
         str_detect(Filename, "SC_|GNA_")) %>%
  separate(Filename, into=c("site","vial","sampledate","rundate","GCn"), sep="_", remove=FALSE, convert=TRUE) %>% 
  mutate(GCn = str_remove(GCn, ".qgd"))
#write_tsv(files21, "files21.tsv")  
files21 <- read_tsv("data/volatiles/files21.tsv")

perc2 <- left_join(perc,files, by=c("Date","DN","Tissue","Sample2"), suffix=c("",".f"))
otc2 <- left_join(otc,files, by=c("Date","Site","temp","DN","Tissue","Sample2"), suffix=c("",".f")) %>% 
  mutate(PlantType = if_else(temp == "air", "air", PlantType))

drop2021 <- c("SC_126_210727_8182021_04.qgd", "SC_101_210727_8202021_02.qgd", "GNA_121_210730_7312021_05.qgd")#don't include these
otc21 <- bind_rows(SC=sc21, GNA=gna21, .id="site") %>% 
  left_join(files21, by=c("vial","site")) %>% 
  filter(!Filename %in% drop2021 | is.na(Filename)) %>% 
  mutate(sampledate = as.character(sampledate),
         Year = 2021, Tissue = if_else(plant == "air", "air", "flower"), Expt="otc",
         location = recode(location,"inside"="warmed","outside"="control"),
         PlantID = paste0(chamber, plant)) %>% 
  rename(Site=site, Collector=observer, Date=date, DN=time, temp=location, Bag=bag, Pump=pump, End=end, Equil=equil, Duration=pumping,
         NumFlrs = flowers, NumBuds=buds, PumpID = pump_id, SoilVWC = VWC, Comments = notes, SampleDate_text=sampledate,
         RunDate_text=rundate,GCOrder=GCn)

#TODO find missing chromatogram files (6) and missing metdata (4)
#otc21 %>% filter(is.na(FileName), is.na(lost))

# Maxfield metadata
maxfiles <- read_csv("data/volatiles/filenames_metadata - filenames_metadata.csv") %>% 
  mutate(Is2021 = str_detect(Filename,"_210")) %>% 
  filter(Maxfield==1 & Year=="2021") %>% 
  separate(Filename2, into=c("plantid","vial","date","rundate","sequence","ext"),remove=F) %>% 
  mutate(across(c(plantid, vial), na_if,"NA")) %>% 
  mutate(date = ymd(date), vial=as.character(vial),
         filament = ifelse(date>ymd("2021-07-21"),"after","before"))

GCMS_metadata1 <- read_csv("data/volatiles/2021 Maxfield Volatiles - 2021.csv") %>% mutate(plotid=paste0(plot, subplot)) %>% 
  left_join(read_csv("data/2021 Maxfield Rosettes - 2021OTCs.csv") %>% mutate(plant=as.character(plant)),
            by=c("plotid","plant","plantid"))

max21.oldformat <- bind_rows(
  left_join(maxfiles %>% filter(vial %in% c("A","B")), GCMS_metadata1, by=c("plantid","vial","date")),
  left_join(maxfiles %>% filter(!vial %in% c("A","B") & is.na(plantid)), GCMS_metadata1, by=c("vial","date")), #vial numbers only
  left_join(maxfiles %>% filter(!vial %in% c("A","B") &!is.na(plantid)), GCMS_metadata1, by=c("plantid","date"))) %>%  #plantid
  mutate(type=factor(ifelse(plant=="air","ambient","floral")), 
         temp=factor(temp.y), snow=factor(snow),
         plantid= coalesce(plantid, plantid.y)) 

max21 <- max21.oldformat %>% #put in line with CWu metadata
  rename(Date=date, RunDate_text=rundate,
         Comments=notes, Collector=observer, Bag=bag, Pump=pump,End=end, 
         NumFlrs=flowers, NumBuds=buds, PumpID=pump_id, SoilVWC=VWC,
         PlantType=type, PlantID=plantid) %>% 
  mutate(vial=as.integer(recode(vial, "A"="1001", "B"="1002")),
         RunDate_text = as.integer(RunDate_text),
         PlantType=recode(PlantType, "ambient"="air", "floral"="agg"),
         Tissue=recode(PlantType, "agg"="flower"),
         Expt="otc",Site="Maxfield",DN="day",
         temp=recode(temp,"OTC"="warmed"))


meta <- bind_rows(otc=bind_rows(otc2, otc21, max21), perc=perc2, .id="expt") %>% 
  mutate_if(is.character, as.factor) %>%
  mutate(Equil=Pump-Bag, Duration=End-Pump, Total=End-Bag,
         Pump_datehour = paste(Date, Pump) %>% ymd_hms(tz="America/Denver") %>% round_date("hour"),
         Expt=expt) %>% #TODO sort thru Expt==NA
  #Add mean temperature of OTCs or controls at time of sampling
  left_join(read_csv("data/hobos_mean.csv") %>% select(-date) %>% 
              mutate(datetime = with_tz(datetime, "America/Denver")), #stored in UTC!
            by = c("Site"="site", "Pump_datehour"="datetime")) %>% 
  mutate(mean_temp_C_treatment = if_else(temp=="warmed", mean_temp_C_warmed, mean_temp_C_control))

meta %>% write.csv("data/volatiles/CWu_meta21.csv")

meta %>% count(Year, Temp, Tissue, PlantType, Site, temp, DN, Expt) %>% kable(caption="Sample size")

tempcol <- set_names(brewer.pal(3, "Set1")[c(2,1)], c("control", "warmed"))#OTCs
Tempcol <- set_names(brewer.pal(3, "Set1")[c(2,1)], c("cool", "warm"))#Percivals
```

## Missing files
```{r nofile}
#perc2 %>% filter(is.na(Filename)) %>% select("n") %>% write.csv("perc_nomatch.csv")
#otc2 %>% filter(is.na(Filename)) %>% select("n") %>% write.csv("otc_nomatch.csv")
meta %>% filter(is.na(Filename) & nomatch!="NR") %>% select(1:24) %>% kable
```

## Missing metadata
```{r nometa}
#files %>% filter(!(Filename %in% meta$Filename)) %>% select("n") %>% write.csv("CWu_samples_nomatch.csv")
files %>% filter(!(Filename %in% meta$Filename) & Expt!="") %>% select(c("Filename", "Date","Site","temp","DN","Tissue","Sample2")) %>% kable
```

## Times
```{r times}
ggplot(meta, aes(x=paste(Expt, DN,Year), y=Pump, color=DN)) + 
  geom_boxplot() + geom_point()+
  theme_minimal() + theme(axis.text.x=element_text(angle=90))+
  ggtitle("Sampling time of day")

ggplot(meta, aes(x=paste(Expt, Site, Year), y=Total/60, color=Tissue)) + 
  geom_point(position=position_dodge(width=0.3))+
  theme_minimal() + theme(axis.text.x=element_text(angle=90)) + 
  ggtitle("Total sampling duration")+
  ylab("Equilibration plus pumping time (min)")

```

## OTC soil moisture
```{r soil}
ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(x=paste(Year, Site, format(Date, "%m-%d")), y=SoilVWC, color=temp)) +
  geom_boxplot(outlier.size=0.5)+
  theme_minimal() + theme(axis.text.x=element_text(angle=90, hjust=0), legend.position="top", 
                          axis.title.x = element_blank()) + 
  scale_color_brewer(palette = "Set1", direction=-1)+
  labs(y="Soil Volumetric Water Content (%)", x="", color="Temperature")

ggplot(meta %>% filter(Expt=="otc", temp !="air",Site != "bb") %>% 
         group_by(Year, Site, Date, temp) %>% summarize(SoilVWC=mean(SoilVWC, na.rm=T)) %>% 
         pivot_wider(names_from=temp, values_from=SoilVWC), 
       aes(x=control, y=warmed, color=Site, shape=factor(Year))) +
  geom_abline(intercept=0, slope=1)+ geom_smooth(aes(group=1), color="black", se=F, span=1)+ geom_point(size=3) + 
  coord_fixed(xlim=c(0,17), ylim=c(0,17))+  theme_minimal() + 
  labs(x="Soil moisture, control (%VWC)", y="Soil moisture, warmed (%VWC)", shape="Year", 
       title="Effects of OTCs on Soil Moisture at Plant on Each Date")
```

## OTC actual temperature
```{r actualtemp}
ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(y=mean_temp_C_treatment, x=paste(Year, Site, temp), color=temp)) +
  facet_grid(cols=vars(DN), scales="free_x", space="free_x")+ 
  geom_boxplot(outlier.shape=NA)+ geom_point(alpha=0.2)+ 
  geom_path(aes(group=paste(Year, Site, Pump_datehour)), color="black", alpha=0.3)+
  theme_minimal() + theme(axis.text.x=element_text(angle=90)) + 
  scale_color_brewer(palette = "Set1", direction=-1)+
  labs(y="Mean hourly temperature (C)", x=("Year, site"), color="Temperature")

ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(y=mean_temp_C_warmed, x=mean_temp_C_control, color=DN))+
  geom_abline(slope=1, intercept=0)+ geom_smooth(se=F)+
  geom_text(aes(label=round(mean_temp_C_warmed-mean_temp_C_control)), alpha=0.2)+ theme_minimal() +
  labs(x= "Mean temperature, controls (C)", y="Mean temperature, warmed (C)", color="Time")

ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(y=mean_temp_C_warmed-mean_temp_C_control, x=hour(Pump), color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
    labs(x= "Time of day", y="Temperature difference (C)", color="Time")

ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(y=mean_temp_C_warmed-mean_temp_C_control, x=mean_temp_C_control, color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
      labs(x= "Mean temperature, controls (C)", y="Temperature difference (C)", color="Time")

ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(x=hour(Pump), y=mean_temp_C_control, color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
  scale_x_continuous(n.breaks=20) +
      labs(x= "Time of day", y="Temperature in controls (C)", color="Time")
```


# Filtering criteria

## Flowers
```{r filtering, fig.height=12, fig.width=12}
sv <- meta %>% drop_na(Filename)
#ipo.gc <- ipo.all[sv$Filename,]

library(bouquet)
ipo.data.cut <- ipo.data[ipo.data$Filename %in% sv$Filename,]
ipo.data.cut$Filename <- sv$Filename[match(ipo.data.cut$Filename, sv$Filename)]
ipo.data.cut <- ipo.data.cut[ipo.data.cut$Name != "", ] #drop unidentified peaks
ipo.data.cut$Name <- droplevels(ipo.data.cut$Name)
longdata <- load_longdata(ipo.data.cut, sample="Filename", RT="Ret.Time", name="Name", area="Area", match = "SI", maxmatch=100)
metadata <- sv %>% as.data.frame() %>% #tibbles break bouquet's add_count_freqs
  mutate(Tissue = fct_recode(Tissue, ambient="air", floral="flower", leaf="leaf"),
         PlantType = factor(if_else(Tissue=="leaf",paste0(PlantType,Tissue), as.character(PlantType)))) %>% 
  load_metadata(date="Date", sample="Filename", group="PlantType", type="Tissue")
vol.all <- make_sampletable(longdata, metadata)
chems <- make_chemtable(longdata, metadata)

### Flower filtering
chemsf <- chems %>%
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.1, group = TRUE) %>% #now filter separately for each species
  filter_contaminant(cont.list = c("Hexyl chloroformate", "Disulfide, di-tert-dodecyl",
                                   "2,2,4-Trimethyl-1,3-pentanediol diisobutyrate")) %>% 
  filter_area(min_maximum = 1e6) %>% 
  filter_ambient_ratio(vol.all, metadata, ratio = 3) %>%
  filter_ambient_ttest(vol.all, metadata, alpha = 0.05, adjust = "fdr") %>%
  combine_filters() 
chemsf$filter_final <- with(chemsf, filter_RT == "OK" & filter_match =="OK" & 
                              (filter_freq.agg == "OK" | filter_freq.ten =="OK") & 
                              filter_area == "OK" & 
                              (filter_ambient_ratio == "OK" | 
                                 (filter_ambient_ttest == "OK" & filter_ambient_ratio == "OK")) &
                              filter_contaminant == "OK")
bouquet::plot_filters(chemsf, option="rarity")
bouquet::plot_filters(chemsf, option="ambient")
bouquet::plot_filters(chemsf, option="prop")
```

## Leaves

```{r filtering_leaf, fig.height=12, fig.width=12}
### Leaf filtering
meta.leaf <- metadata %>% mutate(type = fct_recode(type, floral = "leaf", flower = "floral"))  #trick bouquet to think the leaf samples are floral TODO: hacky!
chems.leaf <- make_chemtable(longdata, meta.leaf) 
chemsf.leaf <- chems.leaf %>%
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.2, group = TRUE) %>%  #now filter separately for each species
  filter_contaminant(cont.list = c("Hexyl chloroformate","Acetic acid, trifluoro-, undecyl ester")) %>% 
  filter_area(min_maximum = 5e5) %>% 
  filter_ambient_ratio(vol.all, meta.leaf, ratio = 4) %>%
  filter_ambient_ttest(vol.all, meta.leaf, alpha = 0.05, adjust = "fdr") %>%
  combine_filters()
chemsf.leaf$filter_final <- with(chemsf.leaf, filter_RT == "OK" & filter_match =="OK" & 
                              (filter_freq.aggleaf == "OK" | filter_freq.tenleaf =="OK") & 
                              filter_area == "OK" & 
                              (filter_ambient_ratio == "OK" | 
                                 (filter_ambient_ttest == "OK" & filter_ambient_ratio == "OK")) &
                              filter_contaminant == "OK")
#TODO bouquet needs to do a one-sided t-test! some compounds lower in blanks got a pass with low p value!
bouquet::plot_filters(chemsf.leaf, option="rarity")
bouquet::plot_filters(chemsf.leaf, option="ambient")
bouquet::plot_filters(chemsf.leaf, option="prop")

#compare amounts in floral vs. leaf samples
chemsf <- chemsf %>% mutate(filter_ambient_leaf_ratio = chemsf.leaf$filter_ambient_ratio,
                            filter_ambient_leaf_ttest = chemsf.leaf$filter_ambient_ttest,
                            leaf_not_flower = filter_ambient_leaf_ratio=="OK" & filter_ambient_leaf_ttest=="OK" & 
                              !(filter_ambient_ratio=="OK" & filter_ambient_ttest=="OK"))

kept_either <- chemsf$filter_final | chemsf.leaf$filter_final
ggplot(chemsf[kept_either,], aes(x=mean.floral, y= chemsf.leaf[kept_either,"mean.floral"], label=name, color=paste(filter_final,chemsf.leaf[kept_either,"filter_final"], sep=", ")))+ theme_minimal()+
  geom_abline(slope=1, intercept=1) +   geom_point(aes(size=RT), alpha=0.3)+  geom_text()+ 
  scale_x_log10()+ scale_y_log10() + coord_fixed()+
  scale_color_manual(labels=c("leaf","floral","both"),values=c("darkgreen","red","blue"))+
  labs(x="Mean area in flowers", y= "Mean area in leaves", color="Kept in dataset")
```

```{r pruning}
vol <- prune_sampletable(vol.all, chemsf, metadata)
vol.leaf <- prune_sampletable(vol.all, chemsf.leaf, meta.leaf)

colnames(vol)[!colnames(vol) %in% shortnames]

files_exclude <- c("T196DAug16_09012018.qgd", "A188DAug16_09012018.qgd", "OTC_Z3_190805_8102019_24.qgd", "T139_day_190725_862019_06.qgd", "GNA_17_210716_7202021_18.qgd","Maxfield_27_210723_822021_03.qgd", #no filtered volatiles
                   "SC_91_210715_8202021_10.qgd") #Artemisia leaves
files_exclude_leaf <- c("CWH1LeafJuly27_09022018.qgd","NatArea69leafrenamedJuly25_08312018.qgd", #lack leaf mass
                        "T164_leaf_190731_882019_18.qgd","OTC_Z2_leaf_190805_8102019_23.qgd") #no filtered volatiles

svf <- metadata[metadata$type == "floral" & !(metadata$sample %in% files_exclude),]
svl <- metadata[metadata$type == "leaf" & !(metadata$sample %in% files_exclude_leaf),]

svf$Year <- factor(svf$Year)
svf <- svf %>% mutate_if(is.factor, droplevels) %>% 
  mutate(Treat = paste(temp, Temp) %>% 
           fct_collapse(control=c("control NA","NA cool"),warmed=c("NA warm","warmed NA")))
svl <- svl %>% mutate_if(is.factor, droplevels) %>% 
  mutate(Treat = paste(temp, Temp) %>% 
           fct_collapse(control=c("control NA","NA cool"),warmed=c("NA warm","warmed NA")))

vol <- vol[!(rownames(vol) %in% files_exclude) ,]
vol.leaf <- vol.leaf[!(rownames(vol.leaf) %in% files_exclude_leaf) ,]

vol <- vol / as.numeric(svf$Total, units="hours") / svf$NumFlrs #30 min of equilibration plus 15 minpumping, one flower 
vol.leaf <- vol.leaf / as.numeric(svl$Total, units="hours") / svl$LeafDryWtGrams #area per hour per dry gram leaf
```


```{r convert_areas}
# convert peak areas to nanograms using standards run in each year
ipochemsf <- ipochems[match(colnames(vol), ipochems$shortname),]
for(yr in levels(svf$Year)) {
  thisyr <- svf$Year==yr
  vol[thisyr,] <- sweep(vol[thisyr,], 2, pull(ipochemsf, paste0("area_per_ng",yr)), FUN = '/')
}
ipochemsl <- ipochems[match(colnames(vol.leaf), ipochems$shortname),]
vol.leaf <- sweep(vol.leaf, 2, ipochemsl$area_per_ng2019, FUN = '/')
```


# All filtered samples

## Flower heatmap
```{r heatmap, dev="png", dev.args=list(), fig.height=12, fig.width=12}
#cairo_pdf("ipo_heatmap.pdf", width=12, height=12)
ph  <- pheatmap(as.matrix(t(vol))^(1/3), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=inferno(512),
         annotation_col = data.frame(svf %>% select("Year", "PlantType", "expt", "Treat","DN","Site"), row.names=rownames(vol)), 
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
#dev.off()
```

## Flower NMDS
```{r nmds_filtered}
set.seed(1)
nmds.vol <- metaMDS(sqrt(vol), dist="bray", autotransform = FALSE, trace=F)

TEY <- with(svf, factor(paste(PlantType,expt,Year)))
TEYcols <- brewer.pal(9, "Paired")#[c(1:4,8,5:6)]
spcols <- c(agg="red", ten="violet")
ordiplot(nmds.vol, type = "n")
text(nmds.vol, display="species", cex=0.7, col="grey20")
legend("topleft", levels(svf$DN), pch=c(1,4))
#legend("topright", levels(svf$PlantType), fill=spcols)
legend("bottomright", levels(svf$Year), fill=1:3)
#legend("bottomleft", levels(TEY), fill=TEYcols, cex=0.9)
#points(nmds.vol, display="sites", col=TEYcols[TEY], pch=c(13,19)[svf$DN])
#points(nmds.vol, display="sites", col=spcols[svf$PlantType], pch=c(13,19)[svf$DN])
points(nmds.vol, display="sites", col=svf$Year, pch=c(1,4)[svf$DN])
#points(nmds.vol, display="sites", col=viridis(100)[sqrt(rowSums(vol))/100], pch=19)
```

# OTCs vs. Ambient

## Inventory
```{r otc}
svf %>% filter(expt=="otc") %>% count(PlantType, DN, temp,Year, Site, is.na(mean_temp_C_treatment)) %>% 
  pivot_wider(names_from=temp, values_from=n) %>%  kable(caption="Sample size")

samplesperplant <- svf %>% filter(Expt=="otc") %>% count(PlantType, DN, temp, Year, Site, PlantID)
samplesperplant %>% count(PlantType, DN, Year, Site, n) %>% kable(caption="Sample size per plant")
samplesperplant %>% ggplot(aes(x=n, fill=Site)) + facet_grid(Site ~ Year) + geom_histogram(binwidth=1) + 
  stat_bin(aes(label=stat(count)), y=3, geom="text", binwidth=1) + guides(fill="none") + theme_minimal()

ggplot(svf %>% filter(Expt=="otc"), aes(x=yday(date), fill=Site)) + 
  geom_bar() + facet_wrap(vars(Year), ncol=1) + theme_minimal()

plot.otc <- function(svf.otc, cap.terms=c("mean_temp_C_treatment", "temp"), plot.chems=T) {
  vol.otc <- vol[svf.otc$sample,]
  cap.formula <- reformulate(cap.terms, response = "sqrt(vol.otc)")
  cap.otc <- capscale(cap.formula, distance="bray", data=svf.otc)
  summ.cap <- summary(cap.otc)
  prop.expl <- summ.cap$cont$importance
  ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")
  cap.terms.int <- str_subset(cap.terms, ":")
  anova.cap <- anova(cap.otc, by=ifelse(length(cap.terms.int)>0, "term", "margin"))
  
  plot(cap.otc, type="n", xlim=range(cap.otc$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
  with(svf.otc, 
       title(main=paste("OTC warming:","I.",unique(PlantType), "at", paste(unique(Site), collapse=" & "),unique(Year),
                            do.call(paste0, list(unique(DN), collapse="/")), "n =",nrow(svf.otc))))
  if("temp" %in% cap.terms) legend("topleft", title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), 
                                   levels(svf.otc$temp), fill=tempcol)
  if("DN" %in% cap.terms) legend("topright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), 
                                 levels(svf.otc$DN), pch=c(1,19))
  if(length(cap.terms.int)>0) legend("bottomleft", title= paste("Interaction\nP =", anova.cap[cap.terms.int,"Pr(>F)"]), legend="")
  temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
  if("mean_temp_C_treatment" %in% cap.terms) legend("bottomleft", 
                                                    title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]),
                                                    paste(temprange, " C"), fill=rev(viridis(2)))
  if("Site" %in% cap.terms) legend("bottomright",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]),
                                   unique(svf.otc$Site))
  ordispider(cap.otc, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
  points(cap.otc, display="sites", col=c(tempcol)[svf.otc$temp], pch=c(1,19)[svf.otc$DN]) 
  text(cap.otc, display="cn")
  if(plot.chems) {
    if(length(cap.terms)>1) text(cap.otc, display="species", cex=0.8, srt=45,
                     col=ifelse(sqrt(cap.otc$CCA$v[,1]^2 + cap.otc$CCA$v[,2]^2)>0.25, alpha("purple",1),alpha("purple",0)))
    else text(cap.otc, display="species", cex=0.8, srt=45,
              col=ifelse(abs(cap.otc$CCA$v[,1])>0.1, alpha("purple",1),alpha("purple",0)))
  }
  return(cap.otc)
}

plot.terms <-c("mean_temp_C_treatment", "temp")
```


## CAP of *I. aggregata*

### Each year and site

```{r otc_agg}
cap.siteyr.agg <- svf %>% filter(expt=="otc", PlantType=="agg") %>% 
  drop_na(mean_temp_C_treatment) %>% 
  group_by(Site, Year) %>% summarize(meta = list(cur_data_all()), .groups = "drop") %>% 
  arrange(Site, Year) %>% #nest that keeps groups
  mutate(samples = map_int(meta, nrow),
         cap = map(meta, plot.otc),
         anova = map(cap, ~tidy(anova(.x, by="margin"))))

cap.siteyr.agg %>% select(-c(meta,cap)) %>% unnest(anova) %>% 
  filter(term!="Residual") %>% select(-c(df, SumOfSqs,statistic)) %>% 
  pivot_wider(names_from=term, values_from=p.value) %>% 
  rename(N=samples, Temperature=mean_temp_C_treatment, Treatment=temp) %>% 
  kable(caption="I. aggregata site-year CAP p-values")
```

### 2021 both sites

```{r otc_comb_year}
cap.yr.agg <- svf %>% filter(expt=="otc", PlantType=="agg", year == "2021") %>% 
  drop_na(mean_temp_C_treatment) %>% 
  group_by(Year) %>% summarize(meta = list(cur_data_all()), .groups = "drop") %>% 
  mutate(samples = map_int(meta, nrow),
         cap = map(meta, plot.otc, cap.terms=c(plot.terms, "Site")),
         anova = map(cap, ~tidy(anova(.x, by="margin"))))

cap.yr.agg %>% select(-c(meta,cap)) %>% unnest(anova) %>% 
  filter(term!="Residual") %>% select(-c(df, SumOfSqs,statistic)) %>% 
  pivot_wider(names_from=term, values_from=p.value) %>% 
  rename(N=samples, Temperature=mean_temp_C_treatment, Treatment=temp) %>% 
  kable(caption="I. aggregata year CAP p-values")
```

### All years
```{r otc_comb_temp}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="agg") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year + Site + Site*mean_temp_C_treatment + Year*mean_temp_C_treatment + temp, distance="bray", data=svf.otc))
(anova.cap <- anova(cap.otc.comb, by="term"))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("OTC warming: I. agg at all sites, all years", "n =", nrow(svf.otc)))
temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
legend("topleft",  title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]), legend=paste(temprange, " C"), fill=rev(viridis(2)))
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), levels(svf.otc$Year), pch=yearpch)
legend("bottomright",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]), legend=unique(svf.otc$Site))
legend("bottomleft",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp))
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
ordispider(cap.otc.comb, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
points(cap.otc.comb, display="sites", col=inferno(round(temprange[1]-temprange[2]))[round(svf.otc$mean_temp_C_treatment-temprange[2])+1], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
```

## CAP of *I. tenuituba*

### Each year
```{r otc_ten}
cap.yr.ten <- svf %>% filter(expt=="otc", PlantType=="ten") %>% 
  group_by(Year) %>% summarize(meta = list(cur_data_all()), .groups = "drop") %>% 
  mutate(samples = map_int(meta, nrow),
         cap = map(meta, plot.otc, cap.terms=c("DN","temp","DN:temp")),
         anova = map(cap, ~tidy(anova(.x, by="term"))))

cap.yr.ten %>% select(-c(meta,cap)) %>% unnest(anova) %>% 
  filter(term!="Residual") %>% select(-c(df, SumOfSqs,statistic)) %>% 
  pivot_wider(names_from=term, values_from=p.value) %>% 
  rename(N=samples, Time=DN, Treatment=temp, "Time:Treatment"="DN:temp") %>% 
  kable(caption="I. tenuituba year CAP p-values")
```

### Both years, day
```{r otc_comb_temp_tenD}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten", DN=="day") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year*mean_temp_C_treatment + temp, distance="bray", data=svf.otc))
(anova.cap <- anova(cap.otc.comb, by="term"))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("OTC warming: I. ten, 2019/2021 day","n =", nrow(svf.otc)))
temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
legend("topleft",  title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]), legend=paste(temprange, " C"), fill=rev(viridis(2)))
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), legend=unique(svf.otc$Year), pch=yearpch[unique(svf.otc$Year)])
legend("left",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp))
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
ordispider(cap.otc.comb, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
points(cap.otc.comb, display="sites", col=inferno(round(temprange[1]-temprange[2]))[round(svf.otc$mean_temp_C_treatment-temprange[2])+1], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
```

### Both years, night
```{r otc_comb_temp_tenN}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten", DN=="night")
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year*temp, distance="bray", data=svf.otc))
(anova.cap <- anova(cap.otc.comb, by="term"))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("OTC warming: I. ten, 2019/2021 night","n =", nrow(svf.otc)))
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), legend=unique(svf.otc$Year), pch=yearpch[unique(svf.otc$Year)])
legend("left",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp), fill=tempcol)
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
ordispider(cap.otc.comb, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
points(cap.otc.comb, display="sites", col=tempcol[svf.otc$temp], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
```

## Both species, day
```{r otc_both_species}
svf.otc <- svf %>% filter(expt=="otc", DN=="day") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year + Site + mean_temp_C_treatment + temp, distance="bray", data=svf.otc))
(anova.cap <- anova(cap.otc.comb, by="term"))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("OTC warming: I. agg & ten at all sites, all years, day","n =", nrow(svf.otc)))
temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
legend("topleft",  title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]), legend=paste(temprange, " C"), fill=rev(viridis(2)))
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), levels(svf.otc$Year), pch=yearpch)
legend("bottomright",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]), legend=unique(svf.otc$Site))
legend("bottomleft",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp))
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
ordispider(cap.otc.comb, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
points(cap.otc.comb, display="sites", col=inferno(round(temprange[1]-temprange[2]))[round(svf.otc$mean_temp_C_treatment-temprange[2])+1], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
```

## Selection gradients

Following method of [Chong et al. 2018](https://doi.org/10.1002/evl3.63) for reconstructing selection estimates from estimates of selection on PCs: Beta = E * A.

```{r gradients, fig.height=6}
minsamples <- 70
vol.top <- vol[,colSums(decostand(vol,"pa"))> minsamples]#occur in more than minsamples

sds <- read_csv("data/2021_Maxfield_sds.csv") %>% 
  mutate(prop_uninfested = 1 - prop_infested, 
         plant=as.character(plant))

fitnesstraits <- c("seeds_est", "seeds_per_flower", "prop_uninfested") #"eggs_per_flower"
fitnessnames <- set_names(c("Estimated total seeds", "Estimated seeds per flower", "Prop. nonaborted fruits uninfested"), fitnesstraits)

# Run PCA on traits
vols.PCA <- vol.top %>% mutate(across(everything(), ~ (.x-mean(.x, na.rm=T))/sd(.x, na.rm=T))) %>% 
  prcomp() 
summary(vols.PCA) # PCs 1 - 5 explain 63% of the variation, #PCs total = top volatiles
vols.PCA.E <- vols.PCA$rotation[,1:5] #min(4, ncol(vols.PCA$rotation))

calculate_beta <- function(E, slopes) {
  data.frame(B = E %*% slopes$A,
             SE = sqrt(E ^ 2 %*% slopes$SE ^ 2)) %>% 
    mutate(not_zero = abs(B) - SE > 0) %>% 
    rownames_to_column("trait")
}

selection_pca <- function(temp=c("control","warmed"), fitnesstrait = "seeds_est") {
  vols.std.PCA <- svf %>% bind_cols(as.data.frame(vols.PCA$x)) %>% 
    filter(temp %in% .env$temp) %>% 
    mutate(plant=as.character(plant)) %>% 
    left_join(sds, by=c("plotid", "plant","temp")) %>% 
    select(all_of(fitnesstrait), "temp", starts_with("PC")) %>% 
    rename("fitness" = fitnesstrait) %>% 
    mutate(relfitness = fitness/mean(fitness, na.rm=T), .keep="unused") %>% ungroup %>% 
    drop_na(relfitness) %>% 
    select(where(~sum(is.na(.))==0))
  
  # Regress relative fitness on PCs
  vols.PCA.regression <- lm(relfitness ~ PC1 + PC2 + PC3 + PC4 + PC5, data = vols.std.PCA)
  vols.PCA.slopes <- tidy(vols.PCA.regression) %>% filter(term != "(Intercept)") %>% rename(A=estimate, SE=std.error)
  
  # Convert selection gradients on PCs to gradients on traits
  calculate_beta(vols.PCA.E, vols.PCA.slopes)
}

plot_beta <- function(betas) {
  bs <- betas %>% left_join(ipochems, by=c("trait"="name")) %>% 
    mutate(trait = fct_reorder(trait, map_dbl(vol.top[,trait], mean)))#order graph by mean emissions
  ggplot(bs, aes(y=trait, x = B, xmin=B-SE, xmax=B+SE)) + 
    geom_vline(xintercept=0)+ 
    geom_pointrange(aes(color=temp), position=position_dodge(width=0.5)) + 
    labs(x = "Selection gradient (beta) estimated from PCs", y = "",   color="Temperature") +
    scale_color_manual(values=tempcol) + theme_minimal() + #+ scale_x_continuous(limits=c(-0.55,0.55), n.breaks=10)  +
    theme(legend.position="bottom")
}

vols.beta.temp <- expand_grid(temp=c("control","warmed"),  fitnesstrait=fitnesstraits)  %>% 
  mutate(betas = pmap(., selection_pca)) %>% unnest(betas)

walk(fitnesstraits, ~print(plot_beta(filter(vols.beta.temp, fitnesstrait==.x)) + ggtitle(fitnessnames[.x])))
```

# Percivals warm vs. cool

## CAP analysis of each Percival dataset
```{r perc}
#inventory of samples
svf %>% filter(expt=="perc") %>%  count(PlantType, DN, Temp,Year) %>% kable(caption="Sample size")

plot.perc <- function(svf.perc, plot.chems=T) {
    vol.perc <- vol[svf.perc$sample,]
    cap.perc <- capscale(sqrt(vol.perc) ~ DN+Temp, distance="bray", data=svf.perc)
    summ.cap <- summary(cap.perc)
    prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
    ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
    anova.cap <- anova(cap.perc, by="margin")
    
    plot(cap.perc, type="n", xlim=range(cap.perc$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
    with(svf.perc, title(paste0("Percivals: I. ", unique(PlantType)," in ", unique(Year), " n = ", nrow(svf.perc))))
    #, " (",round(100*summ.cap$constr.chi / summ.cap$tot.chi),"% explained)")
    legend("topleft", title=paste("Temperature","\nP =",anova.cap["Temp","Pr(>F)"]), 
           levels(svf.perc$Temp), fill=Tempcol)
    legend("topright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), 
           levels(svf.perc$DN), pch=c(1,19))
    if(plot.chems) text(cap.perc, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.perc$CCA$v[,1]^2 + cap.perc$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
    ordispider(cap.perc, with(svf.perc, paste(Year, Temp, Sample2)), col="grey80")
    points(cap.perc, display="sites", col=Tempcol[svf.perc$Temp], pch=c(1,19)[svf.perc$DN]) 
    text(cap.perc, display="cn")
    return(cap.perc)
}
cap.perc.agg18 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2018",PlantType=="agg"))
cap.perc.agg19 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2019",PlantType=="agg"))
cap.perc.ten18 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2018",PlantType=="ten"))
cap.perc.ten19 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2019",PlantType=="ten"))
#cap.perc.all <- list(agg18=cap.perc.agg18, agg19=cap.perc.agg19, ten18=cap.perc.ten18, ten19=cap.perc.ten19)
#lapply(cap.perc.all, anova, by="margin")
```

## CAP of Percival dataset combined for each species

```{r perc_comb}
plot.perc.comb <- function(svf.perc, plot.chems=F) {
  vol.perc <- vol[svf.perc$sample,]
  cap.perc.comb <- capscale(sqrt(vol.perc) ~ Year+DN+Temp, distance="bray", data=svf.perc)
    summ.cap <- summary(cap.perc.comb)
    prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
    ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
    anova.cap <- anova(cap.perc.comb, by="margin")
    
    plot(cap.perc.comb, type="n", xlim=range(cap.perc.comb$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
    title(paste("Percivals: I.",unique(svf.perc$PlantType), "2018/2019","n =", nrow(svf.perc)))
    legend("bottomleft", title=paste("Temperature","\nP =",anova.cap["Temp","Pr(>F)"]), levels(svf.perc$Temp), fill=Tempcol)
  legend("bottomright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), levels(svf.perc$DN), fil=c(0,1))
  legend("topright", title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), levels(svf.perc$Year), pch=c(19,15))
  ordispider(cap.perc.comb, with(svf.perc, paste(Year, Temp, Sample2)), col="grey80")
  points(cap.perc.comb, display="sites", col=Tempcol[svf.perc$Temp], pch=c(1,0,19,15)[factor(paste(svf.perc$DN, svf.perc$Year))]) 
  text(cap.perc.comb, display="cn")
  text(cap.perc.comb, display="species", cex=0.7, srt=45, col=ifelse(sqrt(cap.perc.comb$CCA$v[,1]^2 + cap.perc.comb$CCA$v[,2]^2)>0.2, alpha("purple",1),alpha("purple",0)))
  return(cap.perc.comb)
}
svf.perc.agg <- plot.perc.comb(svf %>% filter(expt=="perc", PlantType=="agg"))
svf.perc.ten <- plot.perc.comb(svf %>% filter(expt=="perc", PlantType=="ten"))
#svf.perc.both <- plot.perc.comb(svf %>% filter(expt=="perc"))
```

# Individual volatiles

## Treatment effects
```{r barplots, fig.width=15, fig.height=11}
vols.plot <- chemsf %>% filter(filter_final, freq.floral>0.3) %>% pull("name") %>% as.character
#vols.plot[vols.plot=="b-caryophyllene"] <- "b-caryophyllene.1"#c("b-ocimene","a-pinene","a-farnesene","b-caryophyllene.1","petasitene","b-myrcene","longifolene","tridec-1-ene  ","benzophenone")
vol.long <- gather(cbind(sample=rownames(vol[,vols.plot]), total=rowSums(vol), vol[,vols.plot]), key="chem",value="area", 2:(length(vols.plot)+2), factor_key=T)
vol.plot <- left_join(vol.long, svf)

specDNcols <- c( "#943390","#FF5056", "#A894FF","#FC8C97")
#Treatcols <- c("#DA9E18","#6B744F")
DNcols <- c("grey90","grey20")
ggplot(drop_na(vol.plot, PlantType, expt),#TODO track down NAs
       aes(x=paste(PlantType,ifelse(is.na(Site), "", Site),expt),y=area,  fill=DN, color=paste(Year, Treat))) +
  geom_boxplot(size=0.7, outlier.size=0.7, position=position_dodge2(preserve="single")) + 
  facet_wrap(vars(chem), scales="free") + 
  scale_y_sqrt("ng per flower per hour") + 
  scale_color_brewer("Year, treatment", palette = "Paired")+
  scale_x_discrete("Species, site, experiment")+
  #scale_color_manual("Species, Treatment", values=specDNcols) + 
  scale_fill_manual("Time of day",values=DNcols) + 
  theme_minimal() + theme(axis.text.x=element_text(angle=20, vjust=0.5))
```

## Actual temperature effects
```{r temptrend, fig.width=15, fig.height=11}
ggplot(drop_na(vol.plot, PlantType, expt) %>% filter(expt=="otc"),#TODO track down NAs
       aes(x=mean_temp_C_treatment, y=area, shape=DN, color=paste(PlantType, Site, Year))) +
  geom_point() + geom_smooth(se=F, method="lm")+
  facet_wrap(vars(chem), scales="free_y") + 
  scale_y_sqrt("ng per flower per hour") + 
  scale_x_continuous("Mean temperature in controls or OTCs (C)")+
  scale_color_brewer("Species, site, year", palette = "Dark2", direction=-1)+#scale_color_manual("Species", values=spcols) + 
  scale_shape_manual("Time of day",values=c(1,19)) + 
  theme_minimal() + theme(axis.text.x=element_text(angle=20, vjust=0.5))
```


# Leaf volatiles

## Inventory

Dropped 2 samples from 2018 without leaf mass. Volatiles units are ng per hour per gram dry leaf.

```{r inventory_leaf}
svl %>% count(PlantType, Treat, expt) %>% kable(caption="Sample size")
```

## Heatmap
```{r heatmap_leaf, dev="png", dev.args = list(), fig.height=8, fig.width=12}
#cairo_pdf("ipo_heatmap_leaf.pdf", width=12, height=12)
ph_leaf  <- pheatmap(as.matrix(t(vol.leaf))^(1/3), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol.leaf, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=inferno(512),
         annotation_col = data.frame(svl %>% select("PlantType", "expt", "Treat"), row.names=rownames(vol.leaf)), 
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
#dev.off()
```

## Leaf NMDS
```{r nmds_filtered_leaf}
set.seed(1)
nmds.vol_leaf <- metaMDS(sqrt(vol.leaf), dist="bray", autotransform = FALSE, trace=F)

TEY <- with(svl, factor(paste(PlantType,expt,Year)))
TEYcols <- brewer.pal(9, "Paired")#[c(1:4,8,5:6)]
spcols <- c(aggleaf="red", tenleaf="violet")
ordiplot(nmds.vol_leaf, type = "n")
legend("bottomleft", levels(TEY), fill=TEYcols, cex=0.9)
points(nmds.vol_leaf, display="sites", col=TEYcols[TEY], pch=19)
text(nmds.vol_leaf, display="species", cex=0.7, col="grey20")
#points(nmds.vol_leaf, display="sites", col=viridis(100)[sqrt(rowSums(vol.leaf))/26], pch=19)
```

## CAP - OTCs
```{r cap_leaf_otc}
svl.otc <- svl %>% filter(expt=="otc")
cap.leaf <- capscale(sqrt(vol.leaf[svl$expt=="otc",]) ~ PlantType+temp, distance="bray", data=svl.otc)
summ.cap <- summary(cap.leaf)
prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
(anova.cap <- anova(cap.leaf, by="margin"))

plot(cap.leaf, type="n", xlim=range(cap.leaf$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("OTCs: I. agg and I. ten leaves 2019","n =", nrow(svl.otc)))
legend("bottomleft", title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svl.otc$temp), fill=tempcol)
legend("bottomright", title=paste("Species","\nP =",anova.cap["PlantType","Pr(>F)"]), levels(svl.otc$PlantType), pch=c(19,15))
points(cap.leaf, display="sites", col=tempcol[svl.otc$temp], pch=c(19,15)[svl.otc$PlantType]) 
text(cap.leaf, display="cn")
text(cap.leaf, display="species", cex=0.7, col=ifelse(sqrt(cap.leaf$CCA$v[,1]^2 + cap.leaf$CCA$v[,2]^2)>0.2, alpha("purple",1),alpha("purple",0)))
```


## CAP - Percivals

```{r cap_leaf_perc}
svl.perc <- svl %>% filter(expt=="perc")
cap.leaf.perc <- capscale(sqrt(vol.leaf[svl$expt=="perc",]) ~ PlantType+Temp, distance="bray", data=svl.perc)
summ.cap <- summary(cap.leaf.perc)
prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
(anova.cap <- anova(cap.leaf.perc, by="margin"))
```
