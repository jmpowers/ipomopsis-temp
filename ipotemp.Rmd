---
title: "Ipomopsis temperature experiments: Volatiles"
author: "Carrie Wu, John Powers, David Hopp, Diane Campbell"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: no
    lib_dir: libs
    code_folding: hide
    toc: yes
    toc_float: TRUE 
editor_options: 
  chunk_output_type: console
---
<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>

```{r setup, include=FALSE}
library(reshape2)
library(tidyverse)
library(lubridate)
library(vegan)
library(viridis)
library(RColorBrewer)
library(pheatmap)
library(dendsort)
library(knitr)
knitr::opts_chunk$set(comment="", cache=T, warning=F, message=F, 
                      fig.path = "plots/", dev="svglite", dev.args=list(fix_text_size=FALSE), fig.height=8, fig.width=8)

#setwd("~/MyDocs/MEGA/UCI/Schiedea/Analysis/scent/rmbl/CWu")
#source("read_shimadzu.R")
```

```{r read_scents}
# setwd("/media/C/GCMSsolution/Data/heather Ipo/")
# data18 <- read.shimadzu("./Temperature expt CWu 2018/CWu2018.txt")
# data19 <- read.shimadzu("./Temperature expt CWu 2019/CWu2019..txt")
# ipo.data <- rbind(data18, data19)
# 
# files.2021 <- c("Ihyb_VF_210718.txt", "Ihyb_VF_210719.txt", "Samples_210720.txt", 
#  "Ihyb_Corydalis_210728.txt", "Ihyb_Corydalis_210729.txt", "Ihyb_Corydalis_210730.txt", "Ihyb_Corydalis_210731.txt", "Maxfield_SC_210802b.txt",  
# "Maxfield_SC_210803.txt",    "SC_GNA_210804.txt",  "Lupinus20_SC_Lagg21_210814.txt" ,"SC_210817.txt", "SC_210818.txt",     
# "SC_210818b.txt",     "SC_210818b001.txt",  "SC_210820b.txt",     "SC_Lagg_210821.txt"  )
# 
# library(tidyverse)
# setwd("~/MyDocs/MEGA/UCI/Schiedea/Analysis/scent/rmbl/RMBL Batches")
# ipo.data.2021 <- map_dfr(files.2021, read.shimadzu)
# 
# ipo.data <- rbind(ipo.data, ipo.data.2021)
#     
# save(ipo.data, file="CWu_181921.Rdata")
load("data/CWu_181921.Rdata")

ipo.all <- dcast(ipo.data, Filename~Name, sum, value.var="Area")
rownames(ipo.all) <- ipo.all[,1]
ipo.all[,1] <- NULL

ipo.cut <- ipo.all[,colSums(ipo.all)>4e6]

write(rownames(ipo.all), "data/CWu_samples.txt")

ipos <- read.csv("data/CWu_samples.csv", colClasses=list(RunDate="Date"))


# Maxfield

# setwd("~/Downloads/MaxfieldVols21/batches")
# source("../read_shimadzu.R")
# datafiles <- list.files(pattern=".txt") # TODO had to copy over newer Maxfield_210802.txt and add Maxfield_SC_210802b.txt
# GCMS_output <- map(datafiles, read.shimadzu)
# filenames <- set_names(GCMS_output,datafiles) %>% bind_rows(.id="Batch") %>% as_tibble %>% 
#   group_by(Batch, Filename) %>% tally
# setwd("~/Downloads/MaxfieldVols21/")#"data" folder
# write_csv(filenames, "filenames.csv")
#... load in GCMS_metadata 
#GCMS_Maxfield_21 <- GCMS_output %>% bind_rows() %>% filter(Filename %in% GCMS_metadata$Filename)
#save(GCMS_Maxfield_21, file="Maxfield_21.Rdata")

load("data/Maxfield_21.Rdata") #GCMS_Maxfield_21 output from david_gcms_ipomopsis (3).R

ipo.data <- bind_rows(ipo.data, GCMS_Maxfield_21)
```

# Overview - no metadata
## Inventory
```{r inventory}
#TODO merge F, G, H, I, J into GNA for 2018
with(ipos, table(Year, Type))
with(ipos, table(Type, DNLeaf))
```

## NMDS
```{r nmds, eval=FALSE}
set.seed(1)
nmds.ipo <- metaMDS(decostand(ipo.cut, "hellinger"), dist="bray", autotransform = FALSE, try=5, trymax=5)

par(bg="grey40")
ordiplot(nmds.ipo, type = "n")
ipos$rs <- rowSums(ipo.all)
ipos$nameBlank <- ipos$Type %in% c("Blank","Bake")
ipos$nameAir <- ipos$Type == "Air"
thisyear <- ipos$Year == 2019
#with(ipos, points(nmds.ipo, display="sites", col=viridis(200)[round(200*sqrt(rs/max(rs)))], pch=as.integer(isblank)+1))
with(ipos, points(nmds.ipo, display="sites", col=rainbow(nlevels(ipos$Type))[ipos$Type], pch=as.integer(nameAir*2+nameBlank)+1))
#with(ipos, points(nmds.ipo, display="sites", col=rainbow(nlevels(ipos$Type))[ipos$Type], pch=ipos$Year-2017))
legend("topright", legend=levels(ipos$Type), fill=rainbow(nlevels(ipos$Type)), cex=0.8)
```

## Kmeans clustering
```{r kmeans, eval=FALSE}
k <- 8
set.seed(1)
km <- kmeans(decostand(ipo.cut, "log"), k, nstart=3)
ipos$Cluster <- km$cluster
ipos$kBlank <- kblank <- km$cluster %in% c(4)
ipos$Mixup <- ipos$nameBlank != ipos$kBlank
with(ipos, table(kBlank, nameBlank))

ordiplot(nmds.ipo, type = "n")
points(nmds.ipo, display="sites", col=ifelse(kblank, "black", rainbow(k)[km$cluster]), pch=with(ipos,as.integer(nameAir*2+nameBlank))+1) 
text(nmds.ipo, display="species",col="grey80",labels=ifelse(colSums(ipo.cut)>4e8, colnames(ipo.cut), ""))
text(nmds.ipo, display="sites", col=with(ipos, as.integer(thisyear)*4+as.integer(nameBlank)*2+as.integer(nameAir)+1), labels=as.character(km$cluster))
```


## CAP - blanks and years
```{r cap_blankyear, eval=FALSE}
ipo.cap <- capscale(ipo.cut ~ as.factor(ipos$kBlank) * as.factor(thisyear), distance="bray", metaMDSdist = F)
plot(ipo.cap, type="n")
points(ipo.cap, display="sites", col=ifelse(ipos$kBlank, "black", rainbow(k)[ipos$Cluster]), pch=as.integer(ipos$nameAir*2+ipos$nameBlank)+1) 
#View(ipo.cap$CCA$v)
```

## CAP - DNLeaf
```{r cap_DNLeaf, eval=FALSE}
dnl <- ipos$DNLeaf!="" & ipos$Type !="Air"
ipo.cap.dnl <- capscale(ipo.cut[dnl,] ~ ipos[dnl,"DNLeaf"], distance="bray", metaMDSdist = F)
plot(ipo.cap.dnl, type="n")
points(ipo.cap.dnl, display="sites", pch=as.integer(ipos[dnl,"DNLeaf"])-1, col=as.integer(factor(ipos[dnl,"Type"]))) 
legend("bottomleft", levels(factor(ipos[dnl,"Type"])), fill=1:nlevels(ipos$Type), cex=0.8)
legend("left", levels(ipos[dnl,"DNLeaf"]), pch=1:nlevels(ipos[dnl,"DNLeaf"])-1, cex=0.8)
#View(ipo.cap.dnl$CCA$v)
```

# Read metadata
```{r metadata}
files <- read_tsv("data/CWu_samples_text2.csv") %>% 
  rename(temp=OI) %>% mutate(temp = recode(temp,"in"="warmed","out"="control"))
perc <- read_tsv("data/Percivals2018_2019.csv")
otc <- read_tsv("data/OTC2018_2019.csv")  %>%  
  rename(temp=OI) %>% mutate(temp = recode(temp,"in"="warmed","out"="control"))

sc21 <- read_tsv("data/2021 Spring Creek Volatiles - 2021.tsv") %>% 
   mutate(PlantType=if_else(plant=="air", "air", "ten"))
gna21 <- read_tsv("data/2021 GNA Volatiles - 2021.tsv") %>% 
  mutate(time="day", PlantType=if_else(plant=="air", "air", "agg"))
library(stringr)
files21 <- tibble(Filename = rownames(ipo.all)) %>% 
  filter(str_detect(Filename, "2021"), 
         str_detect(Filename, "SC_|GNA_")) %>%
  separate(Filename, into=c("site","vial","sampledate","rundate","GCn"), sep="_", remove=FALSE, convert=TRUE) %>% 
  mutate(GCn = str_remove(GCn, ".qgd"))
#write_tsv(files21, "files21.tsv")  
files21 <- read_tsv("data/files21.tsv")

perc2 <- left_join(perc,files, by=c("Date","DN","Tissue","Sample2"), suffix=c("",".f"))
otc2 <- left_join(otc,files, by=c("Date","Site","temp","DN","Tissue","Sample2"), suffix=c("",".f")) %>% 
  mutate(PlantType = if_else(temp == "air", "air", PlantType))

drop2021 <- c("SC_126_210727_8182021_04.qgd", "SC_101_210727_8202021_02.qgd", "GNA_121_210730_7312021_05.qgd")#don't include these
otc21 <- bind_rows(SC=sc21, GNA=gna21, .id="site") %>% 
  left_join(files21, by=c("vial","site")) %>% 
  filter(!Filename %in% drop2021 | is.na(Filename)) %>% 
  mutate(sampledate = as.character(sampledate),
         Year = 2021, Tissue = if_else(plant == "air", "air", "flower"), Expt="otc",
         location = recode(location,"inside"="warmed","outside"="control")) %>% 
  rename(Site=site, Collector=observer, Date=date, DN=time, temp=location, Bag=bag, Pump=pump, End=end, Equil=equil, Duration=pumping,
         NumFlrs = flowers, NumBuds=buds, PumpID = pump_id, SoilVWC = VWC, Comments = notes, SampleDate_text=sampledate,
         RunDate_text=rundate,GCOrder=GCn)

#TODO find missing chromatogram files (6) and missing metdata (4)
#otc21 %>% filter(is.na(FileName), is.na(lost))

# Maxfield metadata
maxfiles <- read_csv("data/filenames_metadata - filenames_metadata.csv") %>% 
  mutate(Is2021 = str_detect(Filename,"_210")) %>% 
  filter(Maxfield==1 & Year=="2021") %>% 
  separate(Filename2, into=c("plantid","vial","date","rundate","sequence","ext"),remove=F) %>% 
  mutate(across(c(plantid, vial), na_if,"NA")) %>% 
  mutate(date = ymd(date), vial=as.character(vial),
         filament = ifelse(date>ymd("2021-07-21"),"after","before"))

GCMS_metadata1 <- read_csv("data/2021 Maxfield Volatiles - 2021.csv") %>% mutate(plotid=paste0(plot, subplot)) %>% 
  left_join(read_csv("data/2021 Maxfield Rosettes - 2021OTCs.csv") %>% mutate(plant=as.character(plant)),
            by=c("plotid","plant","plantid"))

max21.oldformat <- bind_rows(
left_join(maxfiles %>% filter(vial %in% c("A","B")), GCMS_metadata1, by=c("plantid","vial","date")),
left_join(maxfiles %>% filter(!vial %in% c("A","B") & is.na(plantid)), GCMS_metadata1, by=c("vial","date")), #vial numbers only
left_join(maxfiles %>% filter(!vial %in% c("A","B") &!is.na(plantid)), GCMS_metadata1, by=c("plantid","date"))) %>%  #plantid
  mutate(type=factor(ifelse(plant=="air","ambient","floral")), 
         temp=factor(temp.y), snow=factor(snow),
         plantid= coalesce(plantid, plantid.y)) 

max21 <- max21.oldformat %>% #put in line with CWu metadata
  rename(Date=date, RunDate_text=rundate,
         Comments=notes, Collector=observer, Bag=bag, Pump=pump,End=end, 
         NumFlrs=flowers, NumBuds=buds, PumpID=pump_id, SoilVWC=VWC,
         PlantType=type) %>% 
  mutate(vial=as.integer(recode(vial, "A"="1001", "B"="1002")),
         RunDate_text = as.integer(RunDate_text),
         PlantType=recode(PlantType, "ambient"="air", "floral"="agg"),
         Tissue=recode(PlantType, "agg"="flower"),
         Expt="otc",Site="Maxfield",DN="day",
         temp=recode(temp,"OTC"="warmed"))
  

meta <- bind_rows(otc=bind_rows(otc2, otc21, max21), perc=perc2, .id="expt") %>% 
  mutate_if(is.character, as.factor) %>%
  mutate(Equil=Pump-Bag, Duration=End-Pump, Total=End-Bag,
         Pump_datehour = paste(Date, Pump) %>% ymd_hms(tz="America/Denver") %>% round_date("hour"),
         Expt=expt) %>% #TODO sort thru Expt==NA
  #Add mean temperature of OTCs or controls at time of sampling
  left_join(read_csv("data/hobos_mean.csv") %>% select(-date) %>% 
              mutate(datetime = with_tz(datetime, "America/Denver")), #stored in UTC!
            by = c("Site"="site", "Pump_datehour"="datetime")) %>% 
  mutate(mean_temp_C_treatment = if_else(temp=="warmed", mean_temp_C_warmed, mean_temp_C_control))

meta %>% write.csv("data/CWu_meta21.csv")

meta %>% count(Year, Temp, Tissue, PlantType, Site, temp, DN, Expt) %>% kable(caption="Sample size")

tempcol <- set_names(brewer.pal(3, "Set1")[c(2,1)], c("control", "warmed"))#OTCs
Tempcol <- set_names(brewer.pal(3, "Set1")[c(2,1)], c("cool", "warm"))#Percivals
```

## Missing files
```{r nofile}
#perc2 %>% filter(is.na(Filename)) %>% select("n") %>% write.csv("perc_nomatch.csv")
#otc2 %>% filter(is.na(Filename)) %>% select("n") %>% write.csv("otc_nomatch.csv")
meta %>% filter(is.na(Filename) & nomatch!="NR") %>% select(1:24) %>% kable
```

## Missing metadata
```{r nometa}
#files %>% filter(!(Filename %in% meta$Filename)) %>% select("n") %>% write.csv("CWu_samples_nomatch.csv")
files %>% filter(!(Filename %in% meta$Filename) & Expt!="") %>% select(c("Filename", "Date","Site","temp","DN","Tissue","Sample2")) %>% kable
```

## Times
```{r times}
ggplot(meta, aes(x=paste(Expt, DN,Year), y=Bag, color=DN)) + 
  geom_boxplot() + geom_point()+
  theme_minimal() + theme(axis.text.x=element_text(angle=90))+
  ggtitle("Sampling time of day")

ggplot(meta, aes(x=paste(Expt, DN,Year), y=Total/60, color=DN)) + 
  geom_boxplot() + geom_point()+
  theme_minimal() + theme(axis.text.x=element_text(angle=90)) + 
  ggtitle("Total sampling duration")+
  ylab("Equilibration plus pumping time (min)")
#TODO fix timings
```

## OTC Soil moisture
```{r soil}
ggplot(meta %>% filter(Expt=="otc", temp !="air"), aes(x=paste(Year, Site), y=SoilVWC, color=temp)) +
  geom_boxplot()+#geom_violin(draw_quantiles=c(0.25, 0.5, 0.75)) + #geom_point(position=position_dodge(width=0.8))+
  theme_minimal() + theme(axis.text.x=element_text(angle=90)) + 
  scale_color_brewer(palette = "Set1", direction=-1)+
  labs(title="Effects of OTCs on Soil Moisture",y="Soil Volumetric Water Content (%)",
       x="Year, site", color="Temperature")

ggplot(meta %>% filter(Expt=="otc", temp !="air"), aes(x=paste(Year, Site, Date), y=SoilVWC, color=temp)) +
  geom_boxplot()+#geom_violin(draw_quantiles=c(0.25, 0.5, 0.75)) + #geom_point()+
  theme_minimal() + theme(axis.text.x=element_text(angle=90)) + 
  scale_color_brewer(palette = "Set1", direction=-1)+
  labs(title="Effects of OTCs on Soil Moisture",y="Soil Volumetric Water Content (%)",
       x="Year, site, date", color="Temperature")
```

## OTC actual temperature
```{r actualtemp}
ggplot(meta %>% filter(Expt=="otc", temp !="air"), 
       aes(y=mean_temp_C_treatment, x=paste(Year, Site, temp), color=temp)) +
  facet_grid(cols=vars(DN), scales="free_x", space="free_x")+ 
  geom_boxplot(outlier.shape=NA)+ geom_point(alpha=0.2)+ 
  geom_path(aes(group=paste(Year, Site, Pump_datehour)), color="black", alpha=0.3)+
  theme_minimal() + theme(axis.text.x=element_text(angle=90)) + 
  scale_color_brewer(palette = "Set1", direction=-1)+
  labs(y="Mean hourly temperature (C)", x=("Year, site"), color="Temperature")

ggplot(meta %>% filter(Expt=="otc", temp !="air"), 
       aes(y=mean_temp_C_warmed, x=mean_temp_C_control, color=DN))+
  geom_abline(slope=1, intercept=0)+ geom_smooth(se=F)+
  geom_text(aes(label=round(mean_temp_C_warmed-mean_temp_C_control)), alpha=0.2)+ theme_minimal() +
  labs(x= "Mean temperature, controls (C)", y="Mean temperature, warmed (C)", color="Time")

ggplot(meta %>% filter(Expt=="otc", temp !="air"), 
       aes(y=mean_temp_C_warmed-mean_temp_C_control, x=hour(Pump), color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
    labs(x= "Time of day", y="Temperature difference (C)", color="Time")

ggplot(meta %>% filter(Expt=="otc", temp !="air"), 
       aes(y=mean_temp_C_warmed-mean_temp_C_control, x=mean_temp_C_control, color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
      labs(x= "Mean temperature, controls (C)", y="Temperature difference (C)", color="Time")

ggplot(meta %>% filter(Expt=="otc", temp !="air"), 
       aes(x=hour(Pump), y=mean_temp_C_control, color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
  scale_x_continuous(n.breaks=20) +
      labs(x= "Time of day", y="Temperature in controls (C)", color="Time")
```


# Filtering criteria

## Flowers
```{r filtering, fig.height=12, fig.width=12}
sv <- meta %>% drop_na(Filename)
#ipo.gc <- ipo.all[sv$Filename,]

library(bouquet)
ipo.data.cut <- ipo.data[ipo.data$Filename %in% sv$Filename,]
ipo.data.cut$Filename <- sv$Filename[match(ipo.data.cut$Filename, sv$Filename)]
ipo.data.cut <- ipo.data.cut[ipo.data.cut$Name != "", ] #drop unidentified peaks
ipo.data.cut$Name <- droplevels(ipo.data.cut$Name)
longdata <- load_longdata(ipo.data.cut, sample="Filename", RT="Ret.Time", name="Name", area="Area", match = "SI", maxmatch=100)
metadata <- sv %>% mutate(Tissue = fct_recode(Tissue, ambient="air", floral="flower", leaf="leaf")) %>% 
  load_metadata(date="Date", sample="Filename", group="PlantType", type="Tissue")
vol.all <- make_sampletable(longdata, metadata)
chems <- make_chemtable(longdata, metadata)


#TODO update this code to convert to nanograms
# classes <- read_csv("Ipo volatile compounds - max21_chemtable.csv")
# table(classes$class)
# stds <- read_csv("shimadzu_standards.xlsx - conversions_2021.csv")
# longdata.ng <- longdata %>% left_join(select(GCMS_metadata, sample=Filename, filament)) %>% 
#   left_join(select(classes, class, name), by="name") %>% 
#   left_join(stds) %>% 
#   mutate(area = area / area_per_ng) #area is no longer area!!! it's nanograms
# sampletable.ng = make_sampletable(longdata.ng, metadata)[,names(sampletable)]

### Flower filtering
chemsf <- chems %>%
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.1, group = FALSE) %>% 
  filter_contaminant(cont.list = c("Cyclotetrasiloxane, octamethyl-",
  "2,2,4-Trimethyl-1,3-pentanediol diisobutyrate")) %>% 
  filter_area(min_maximum = 1e6) %>% 
  filter_ambient_ratio(vol.all, metadata, ratio = 3) %>%
  filter_ambient_ttest(vol.all, metadata, alpha = 0.05, adjust = "fdr") %>%
  combine_filters() 
chemsf$filter_final <- with(chemsf, filter_RT == "OK" & filter_match =="OK" & filter_freq.floral == "OK" & filter_area == "OK" & 
                              (filter_ambient_ratio == "OK" | (filter_ambient_ttest == "OK" & ambient_ratio >1)) & filter_contaminant == "OK")
bouquet::plot_filters(chemsf, option="rarity")
bouquet::plot_filters(chemsf, option="ambient")
bouquet::plot_filters(chemsf, option="prop")
```

## Leaves

```{r filtering_leaf}
### Leaf filtering
meta.leaf <- metadata %>% mutate(type = fct_recode(type, floral = "leaf", flower = "floral")) #trick bouquet to think the leaf samples are floral TODO: hacky!
chems.leaf <- make_chemtable(longdata, meta.leaf) 
chemsf.leaf <- chems.leaf %>%
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.2, group = FALSE) %>% 
  filter_contaminant(cont.list = c("Caprolactam")) %>% 
  filter_area(min_maximum = 5e5) %>% 
  filter_ambient_ratio(vol.all, meta.leaf, ratio = 4) %>%
  filter_ambient_ttest(vol.all, meta.leaf, alpha = 0.05, adjust = "fdr") %>%
  combine_filters()
chemsf.leaf$filter_final <- with(chemsf.leaf, filter_RT == "OK" & filter_match =="OK" & filter_freq.floral == "OK" & #floral are actually leafs
                                   filter_area == "OK" & (filter_ambient_ratio == "OK" | (filter_ambient_ttest == "OK" & ambient_ratio >1)) & filter_contaminant == "OK")
#TODO bouquet needs to do a one-sided t-test! some compounds lower in blanks got a pass with low p value!
bouquet::plot_filters(chemsf.leaf, option="rarity")
bouquet::plot_filters(chemsf.leaf, option="ambient")
bouquet::plot_filters(chemsf.leaf, option="prop")

#compare amounts in floral vs. leaf samples
chemsf <- chemsf %>% mutate(filter_ambient_leaf_ratio = chemsf.leaf$filter_ambient_ratio,
                            filter_ambient_leaf_ttest = chemsf.leaf$filter_ambient_ttest,
                            leaf_not_flower = filter_ambient_leaf_ratio=="OK" & filter_ambient_leaf_ttest=="OK" & 
                              !(filter_ambient_ratio=="OK" & filter_ambient_ttest=="OK"))

ggplot(chemsf, aes(x=mean.floral, y= chemsf.leaf$mean.floral, label=name, color=paste(filter_final,chemsf.leaf$filter_final, sep=", "),
                   alpha=filter_final|chemsf.leaf$filter_final))+ theme_minimal()+
  geom_abline(slope=1, intercept=1) + geom_text()+ scale_x_log10()+ scale_y_log10() +
  labs(x="Mean area in flowers", y= "Mean area in leaves", alpha="Kept in either dataset", color="Kept in floral, leaf datasets")
```

```{r pruning}
### Manual filtering
#write.csv(chemsf, "chemsf_ipo.csv")
#annotated this in a google sheet
chemsf2 <- read.csv("data/Ipo volatile compounds - chemsf_ipo.csv.csv")
keep <- as.character(chemsf2[chemsf2$verdict %in% c("fvoc","keep","merge","keep-leaf"),"name"])
#keep_leaf <- as.character(chemsf2[chemsf2$verdict =="keep_leaf","name"]) # > 4 | chemsf3$name %in% keep_leaf)

#shorten names
shortnames <- chemsf2 %>% select(name, shortname) %>% filter(shortname!="") %>% deframe()
chemsf3 <- chemsf %>% 
  filter_contaminant(cont.list=as.character(chemsf2[chemsf2$verdict %in% c("ambi","bis14","cont","rare"),"name"])) %>% 
  mutate(filter_final_leaf = filter_contaminant == "OK" & chemsf.leaf$filter_final, #& chemsf2$shortname!=""#four big alkanes
         name = recode(name, !!!shortnames))
#chemsf3$filter_final <- with(chemsf3, filters_passed > 4 & filter_contaminant == "OK" & name %in% keep)#keeps with passed<=4 still excluded
colnames(vol.all) <- chemsf3$name

#TODO merge the duplicate name2s - the following doesn't work
#longdata3 <- longdata %>% inner_join(chemsf3 %>% select(c("name", "name2")), by = "name") %>% 
  #mutate(name = factor(name2))
#vol.all3 <- make_sampletable(longdata3) 

#vol <- prune_sampletable(vol.all, chemsf3, metadata)
#TODO use chesf3 (manual list instead)
vol <- prune_sampletable(vol.all, chemsf3, metadata)
files_exclude <- c("T196DAug16_09012018.qgd", "A188DAug16_09012018.qgd", "OTC_Z3_190805_8102019_24.qgd", "T139_day_190725_862019_06.qgd", "GNA_17_210716_7202021_18.qgd","Maxfield_27_210723_822021_03.qgd")#no filtered volatiles
svf <- metadata[metadata$type == "floral" & !(metadata$sample %in% files_exclude),]
svf$Year <- factor(svf$Year)
svf <- svf %>% mutate_if(is.factor, droplevels) %>% 
  mutate(Treat = paste(temp, Temp) %>% 
           fct_collapse(control=c("control NA","NA cool"),warmed=c("NA warm","warmed NA")))
vol <- vol[!(rownames(vol) %in% files_exclude) ,]
vol <- vol / 0.75 / 1 #30 min of equilibration plus 15 minpumping, one flower 
#TODO fix svf$Total data entry errors
```

```{r pruning_leaf}
vol.leaf <- prune_sampletable(vol.all, chemsf3 %>% mutate(filter_final=filter_final_leaf), meta.leaf)
files_exclude_leaf <- c("CWH1LeafJuly27_09022018.qgd","NatArea69leafrenamedJuly25_08312018.qgd", "T164_leaf_190731_882019_18.qgd","OTC_Z2_leaf_190805_8102019_23.qgd")#fist two lack leaf mass, secodn two have no filtered volatiles
svl <- metadata[metadata$type == "leaf" & !(metadata$sample %in% files_exclude_leaf),]
svl <- svl %>% mutate_if(is.factor, droplevels) %>% 
  mutate(Treat = paste(temp, Temp) %>% 
           fct_collapse(control=c("control NA","NA cool"),warmed=c("NA warm","warmed NA")))
vol.leaf <- vol.leaf[!(rownames(vol.leaf) %in% files_exclude_leaf) ,]
svl$LeafDryWtGrams[c(8,3)] <- svl$LeafDryWtGrams[c(8,3)]/10
vol.leaf <- vol.leaf / 0.75 / svl$LeafDryWtGrams #area per hour per dry gram
#TODO fix svf$Total data entry errors for leaves
```


# All filtered samples

## Flower heatmap
```{r heatmap, dev="png", dev.args=list(), fig.height=12, fig.width=12}
#cairo_pdf("ipo_heatmap.pdf", width=12, height=12)
ph  <- pheatmap(as.matrix(t(vol))^(1/3), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=inferno(512),
         annotation_col = data.frame(svf %>% select("Year", "PlantType", "expt", "Treat","DN"), row.names=rownames(vol)), 
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
#dev.off()
```

## Flower NMDS
```{r nmds_filtered}
set.seed(1)
nmds.vol <- metaMDS(sqrt(vol), dist="bray", autotransform = FALSE, trace=F)

TEY <- with(svf, factor(paste(PlantType,expt,Year)))
TEYcols <- brewer.pal(9, "Paired")#[c(1:4,8,5:6)]
spcols <- c(agg="red", ten="violet")
ordiplot(nmds.vol, type = "n")
text(nmds.vol, display="species", cex=0.7, col="grey20")
legend("topleft", levels(svf$DN), pch=c(13,19))
#legend("topright", levels(svf$PlantType), fill=spcols)
legend("bottomright", levels(svf$Year), fill=1:3)
#legend("bottomleft", levels(TEY), fill=TEYcols, cex=0.9)
points(nmds.vol, display="sites", col=TEYcols[TEY], pch=c(13,19)[svf$DN])
points(nmds.vol, display="sites", col=spcols[svf$PlantType], pch=c(13,19)[svf$DN])
points(nmds.vol, display="sites", col=svf$Year, pch=c(13,19)[svf$DN])
#points(nmds.vol, display="sites", col=viridis(100)[sqrt(rowSums(vol))/100], pch=19)
```

# OTCs vs. Ambient

## Inventory
```{r otc}
svf %>% filter(expt=="otc") %>% count(PlantType, DN, temp,Year, Site, is.na(mean_temp_C_treatment)) %>% pivot_wider(names_from=temp, values_from=n) %>%  kable(caption="Sample size")

plot.otc <- function(svf.otc, cap.terms=c("mean_temp_C_treatment", "temp"), plot.chems=T) {
  vol.otc <- vol[svf.otc$sample,]
  cap.formula <- reformulate(cap.terms, response = "sqrt(vol.otc)")
  cap.otc <- capscale(cap.formula, distance="bray", data=svf.otc)
  summ.cap <- summary(cap.otc)
  prop.expl <- summ.cap$cont$importance
  ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")
  cap.terms.int <- str_subset(cap.terms, ":")
  anova.cap <- anova(cap.otc, by=ifelse(length(cap.terms.int)>0, "term", "margin"))
  
  plot(cap.otc, type="n", xlim=range(cap.otc$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
  with(svf.otc, 
       title(main=paste("OTC warming:","I.",unique(PlantType), "at", paste(unique(Site), collapse=" & "),unique(Year),
                            do.call(paste0, list(unique(DN), collapse="/")))))
  if("temp" %in% cap.terms) legend("topleft", title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), 
                                   levels(svf.otc$temp), fill=tempcol)
  if("DN" %in% cap.terms) legend("topright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), 
                                 levels(svf.otc$DN), pch=c(1,19))
  if(length(cap.terms.int)>0) legend("bottomleft", title= paste("Interaction\nP =", anova.cap[cap.terms.int,"Pr(>F)"]), legend="")
  temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
  if("mean_temp_C_treatment" %in% cap.terms) legend("bottomleft", 
                                                    title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]),
                                                    paste(temprange, " C"), fill=rev(viridis(2)))
  if("Site" %in% cap.terms) legend("bottomright",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]),
                                   unique(svf.otc$Site))
  points(cap.otc, display="sites", col=c(tempcol)[svf.otc$temp], pch=c(1,19)[svf.otc$DN]) 
  text(cap.otc, display="cn")
  if(plot.chems) {
    if(length(cap.terms)>1) text(cap.otc, display="species", cex=0.8, srt=45,
                     col=ifelse(sqrt(cap.otc$CCA$v[,1]^2 + cap.otc$CCA$v[,2]^2)>0.25, alpha("purple",1),alpha("purple",0)))
    else text(cap.otc, display="species", cex=0.8, srt=45,
              col=ifelse(abs(cap.otc$CCA$v[,1])>0.1, alpha("purple",1),alpha("purple",0)))
  }
  return(cap.otc)
}

plot.terms <-c("mean_temp_C_treatment", "temp")
```


## CAP of I. aggregata

### Each year and site

```{r otc_agg}
cap.otcbb18 <-  plot.otc(svf %>% filter(expt=="otc",Year=="2018",Site=="bb",PlantType=="agg"))
cap.otcGNA18 <- plot.otc(svf %>% filter(expt=="otc",Year=="2018",Site=="GNA",PlantType=="agg"))
cap.otcGNA19 <- plot.otc(svf %>% filter(expt=="otc",Year=="2019",Site=="GNA",PlantType=="agg", !is.na(mean_temp_C_treatment)))
cap.otcGNA21 <- plot.otc(svf %>% filter(expt=="otc",Year=="2021",Site=="GNA",PlantType=="agg"))
cap.otcMax21 <- plot.otc(svf %>% filter(expt=="otc",Year=="2021",Site=="Maxfield",PlantType=="agg"))
```

### Each year

```{r otc_comb_year}
cap.otc18 <- plot.otc(svf %>% filter(expt=="otc",Year=="2018", DN=="day",PlantType=="agg"), cap.terms=c(plot.terms, "Site"))
cap.otc21 <- plot.otc(svf %>% filter(expt=="otc",Year=="2021", DN=="day",PlantType=="agg"), cap.terms=c(plot.terms, "Site"))
```

### All years
```{r otc_comb_temp}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="agg") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year + Site + Site*mean_temp_C_treatment + Year*mean_temp_C_treatment + temp, distance="bray", data=svf.otc))
(anova.cap <- anova(cap.otc.comb, by="term"))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title("OTC warming: I. agg at all sites, all years")
temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
legend("topleft",  title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]), legend=paste(temprange, " C"), fill=rev(viridis(2)))
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), levels(svf.otc$Year), pch=yearpch)
legend("bottomright",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]), legend=unique(svf.otc$Site))
legend("bottomleft",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp))
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
points(cap.otc.comb, display="sites", col=inferno(round(temprange[1]-temprange[2]))[round(svf.otc$mean_temp_C_treatment-temprange[2])+1], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
```

## CAP of all I. tenuituba

### Each year
```{r otc_ten}
cap.otcSC19 <-  plot.otc(svf %>% filter(expt=="otc",Year=="2019",Site=="SC",PlantType=="ten"), cap.terms=c("DN","temp","DN:temp"))
cap.otcSC21 <-  plot.otc(svf %>% filter(expt=="otc",Year=="2021",Site=="SC",PlantType=="ten"), cap.terms=c("DN","temp","DN:temp"))
```

### Both years, day
```{r otc_comb_temp_tenD}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten", DN=="day") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year*mean_temp_C_treatment + temp, distance="bray", data=svf.otc))
(anova.cap <- anova(cap.otc.comb, by="term"))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title("OTC warming: I. ten, 2019/2021 day")
temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
legend("topleft",  title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]), legend=paste(temprange, " C"), fill=rev(viridis(2)))
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), legend=unique(svf.otc$Year), pch=yearpch[unique(svf.otc$Year)])
legend("left",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp))
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
points(cap.otc.comb, display="sites", col=inferno(round(temprange[1]-temprange[2]))[round(svf.otc$mean_temp_C_treatment-temprange[2])+1], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
```

### Both years, night
```{r otc_comb_temp_tenN}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten", DN=="night")
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year*temp, distance="bray", data=svf.otc))
(anova.cap <- anova(cap.otc.comb, by="term"))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title("OTC warming: I. ten, 2019/2021 night")
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), legend=unique(svf.otc$Year), pch=yearpch[unique(svf.otc$Year)])
legend("left",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp), fill=tempcol)
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
points(cap.otc.comb, display="sites", col=tempcol[svf.otc$temp], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
```

# Percivals warm vs. cool

## CAP analysis of each Percival dataset
```{r perc}
#inventory of samples
svf %>% filter(expt=="perc") %>%  count(PlantType, DN, Temp,Year) %>% kable(caption="Sample size")

plot.perc <- function(svf.perc, plot.chems=T) {
    vol.perc <- vol[svf.perc$sample,]
    cap.perc <- capscale(sqrt(vol.perc) ~ DN+Temp, distance="bray", data=svf.perc)
    summ.cap <- summary(cap.perc)
    prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
    ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
    anova.cap <- anova(cap.perc, by="margin")
    
    plot(cap.perc, type="n", xlim=range(cap.perc$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
    with(svf.perc, title(paste0("Percivals: I. ", unique(PlantType)," in ", unique(Year))))
    #, " (",round(100*summ.cap$constr.chi / summ.cap$tot.chi),"% explained)")
    legend("topleft", title=paste("Temperature","\nP =",anova.cap["Temp","Pr(>F)"]), 
           levels(svf.perc$Temp), fill=Tempcol)
    legend("topright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), 
           levels(svf.perc$DN), pch=c(1,19))
    if(plot.chems) text(cap.perc, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.perc$CCA$v[,1]^2 + cap.perc$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
    points(cap.perc, display="sites", col=Tempcol[svf.perc$Temp], pch=c(1,19)[svf.perc$DN]) 
    text(cap.perc, display="cn")
    return(cap.perc)
}
cap.perc.agg18 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2018",PlantType=="agg"))
cap.perc.agg19 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2019",PlantType=="agg"))
cap.perc.ten18 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2018",PlantType=="ten"))
cap.perc.ten19 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2019",PlantType=="ten"))
#cap.perc.all <- list(agg18=cap.perc.agg18, agg19=cap.perc.agg19, ten18=cap.perc.ten18, ten19=cap.perc.ten19)
#lapply(cap.perc.all, anova, by="margin")
```

## CAP of Percival dataset combined for each species

```{r perc_comb}
plot.perc.comb <- function(svf.perc, plot.chems=F) {
  vol.perc <- vol[svf.perc$sample,]
  cap.perc.comb <- capscale(sqrt(vol.perc) ~ Year+DN+Temp, distance="bray", data=svf.perc)
    summ.cap <- summary(cap.perc.comb)
    prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
    ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
    anova.cap <- anova(cap.perc.comb, by="margin")
    
    plot(cap.perc.comb, type="n", xlim=range(cap.perc.comb$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
    title(paste("Percivals: I.",unique(svf.perc$PlantType), "2018/2019"))
    legend("bottomleft", title=paste("Temperature","\nP =",anova.cap["Temp","Pr(>F)"]), levels(svf.perc$Temp), fill=Tempcol)
  legend("bottomright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), levels(svf.perc$DN), fil=c(0,1))
  legend("topright", title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), levels(svf.perc$Year), pch=c(19,15))
  points(cap.perc.comb, display="sites", col=Tempcol[svf.perc$Temp], pch=c(1,0,19,15)[factor(paste(svf.perc$DN, svf.perc$Year))]) 
  text(cap.perc.comb, display="cn")
  text(cap.perc.comb, display="species", cex=0.7, srt=45, col=ifelse(sqrt(cap.perc.comb$CCA$v[,1]^2 + cap.perc.comb$CCA$v[,2]^2)>0.2, alpha("purple",1),alpha("purple",0)))
  return(cap.perc.comb)
}
svf.perc.agg <- plot.perc.comb(svf %>% filter(expt=="perc", PlantType=="agg"))
svf.perc.ten <- plot.perc.comb(svf %>% filter(expt=="perc", PlantType=="ten"))
#svf.perc.both <- plot.perc.comb(svf %>% filter(expt=="perc"))
```

# Individual volatiles

## Treatment effects
```{r barplots, fig.width=15, fig.height=11}
vols.plot <- chemsf3 %>% filter(filter_final, freq.floral>0.3) %>% pull("name") %>% as.character
#vols.plot[vols.plot=="b-caryophyllene"] <- "b-caryophyllene.1"#c("b-ocimene","a-pinene","a-farnesene","b-caryophyllene.1","petasitene","b-myrcene","longifolene","tridec-1-ene  ","benzophenone")
vol.long <- gather(cbind(sample=rownames(vol[,vols.plot]), total=rowSums(vol), vol[,vols.plot]), key="chem",value="area", 2:(length(vols.plot)+2), factor_key=T)
vol.plot <- left_join(vol.long, svf)

specDNcols <- c( "#943390","#FF5056", "#A894FF","#FC8C97")
#Treatcols <- c("#DA9E18","#6B744F")
DNcols <- c("grey90","grey20")
ggplot(drop_na(vol.plot, PlantType, expt),#TODO track down NAs
       aes(x=paste(PlantType,ifelse(is.na(Site), "", Site),expt),y=area,  fill=DN, color=paste(Year, Treat))) +
  geom_boxplot(size=0.7, outlier.size=0.7, position=position_dodge2(preserve="single")) + 
  facet_wrap(vars(chem), scales="free") + 
  scale_y_sqrt("Peak area per flower per hour") + 
  scale_color_brewer("Year, treatment", palette = "Paired")+
  scale_x_discrete("Species, site, experiment")+
  #scale_color_manual("Species, Treatment", values=specDNcols) + 
  scale_fill_manual("Time of day",values=DNcols) + 
  theme_minimal() + theme(axis.text.x=element_text(angle=20, vjust=0.5))
```

## Actual temperature effects
```{r temptrend, fig.width=15, fig.height=11}
ggplot(drop_na(vol.plot, PlantType, expt) %>% filter(expt=="otc"),#TODO track down NAs
       aes(x=mean_temp_C_treatment, y=area, shape=DN, color=paste(PlantType, Site, Year))) +
  geom_point() + geom_smooth(se=F, method="lm")+
  facet_wrap(vars(chem), scales="free_y") + 
  scale_y_sqrt("Peak area per flower per hour") + 
  scale_x_continuous("Mean temperature in controls or OTCs (C)")+
  scale_color_brewer("Species, site, year", palette = "Dark2", direction=-1)+#scale_color_manual("Species", values=spcols) + 
  scale_shape_manual("Time of day",values=c(1,19)) + 
  theme_minimal() + theme(axis.text.x=element_text(angle=20, vjust=0.5))
```


# Leaf volatiles

## Inventory

Dropped 2 samples from 2018 without leaf mass. Volatiles units are peak area per hour per gram dry leaf.

```{r inventory_leaf}
svl %>% count(PlantType, Treat, expt) %>% kable(caption="Sample size")
```

## Heatmap
```{r heatmap_leaf, dev="png", dev.args = list(), fig.height=8, fig.width=12}
#cairo_pdf("ipo_heatmap_leaf.pdf", width=12, height=12)
ph_leaf  <- pheatmap(as.matrix(t(vol.leaf))^(1/3), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol.leaf, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=inferno(512),
         annotation_col = data.frame(svl %>% select("PlantType", "expt", "Treat"), row.names=rownames(vol.leaf)), 
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
#dev.off()
```

## CAP - OTCs
```{r cap_leaf_otc}
svl.otc <- svl %>% filter(expt=="otc")
cap.leaf <- capscale(sqrt(vol.leaf[svl$expt=="otc",]) ~ PlantType+temp, distance="bray", data=svl.otc)
summ.cap <- summary(cap.leaf)
prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
(anova.cap <- anova(cap.leaf, by="margin"))

plot(cap.leaf, type="n", xlim=range(cap.leaf$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("OTCs: I. agg and I. ten leaves 2019"))
legend("bottomleft", title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svl.otc$temp), fill=tempcol)
legend("bottomright", title=paste("Species","\nP =",anova.cap["PlantType","Pr(>F)"]), levels(svl.otc$PlantType), pch=c(19,15))
points(cap.leaf, display="sites", col=tempcol[svl.otc$temp], pch=c(19,15)[svl.otc$PlantType]) 
text(cap.leaf, display="cn")
text(cap.leaf, display="species", cex=0.7, col=ifelse(sqrt(cap.leaf$CCA$v[,1]^2 + cap.leaf$CCA$v[,2]^2)>0.2, alpha("purple",1),alpha("purple",0)))
```


## CAP - Percivals

```{r cap_leaf_perc}
svl.perc <- svl %>% filter(expt=="perc")
cap.leaf.perc <- capscale(sqrt(vol.leaf[svl$expt=="perc",]) ~ PlantType+Temp, distance="bray", data=svl.perc)
summ.cap <- summary(cap.leaf.perc)
prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
(anova.cap <- anova(cap.leaf.perc, by="margin"))
```
