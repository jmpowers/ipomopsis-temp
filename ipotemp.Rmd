---
title: "Volatiles - Ipomopsis temperature experiments"
author: "Carrie Wu, John Powers, David Hopp, Diane Campbell"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: no
    lib_dir: libs
    code_folding: hide
    toc: yes
    toc_float: TRUE 
editor_options: 
  chunk_output_type: console
---

```{=html}
<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>
```
```{r setup, include=FALSE}
library(reshape2)
library(tidyverse)
library(lubridate)
library(bouquet)
library(vegan)
library(ggvegan)
library(ggrepel)
library(lme4)
library(lmerTest)
library(broom)
library(broom.mixed)
library(viridis)
library(RColorBrewer)
library(pheatmap)
library(dendsort)
library(knitr)
knitr::opts_chunk$set(comment="", cache=T, warning=F, message=F, 
                      fig.path = "plots/", dev="svglite", dev.args=list(fix_text_size=FALSE), fig.height=8, fig.width=8)
```

```{r read_scents}
load("data/volatiles/ipotemp181921.Rdata") 
#write(rownames(ipo.all), "data/volatiles/CWu_samples.txt")
ipos <- read.csv("data/volatiles/CWu_samples.csv", colClasses=list(RunDate="Date")) #TODO this filename split is outdated

# load short names and standard regessions
ipochems <- read_csv("data/volatiles/Ipo volatile compounds - chemsf_ipo.csv") %>% 
  select(name, shortname, standard, verdict) %>%  filter(verdict != "") %>% 
  mutate(standard = fct_recode(standard, "Methyl_salicylate"="Benzaldehyde"), # benzaldehyde regressions not reliable
         class = fct_recode(standard, Aliphatic="Hexenol", Benzenoid="Methyl_salicylate", Benzenoid="Indole", 
                            Sesquiterpene="Caryophyllene", Monoterpene="alpha_Pinene", Monoterpene="Linalool")) %>%  
  left_join(read_csv("data/volatiles/regressions_181921_filtered_slopes.csv") %>% 
              pivot_wider(id_cols=standard, names_from="year", names_prefix="area_per_ng", values_from=area_per_ng)) 
class_pal <- set_names(c("#BC0060","#027B8C","#E56E00","#86D400"), levels(ipochems$class))

#shorten chemical names and merge compounds with multiple names
shortnames <- ipochems %>% select(name, shortname) %>% filter(shortname!="") %>% deframe()
#shortnames[shortnames %in% shortnames[duplicated(shortnames)]]
ipo.data$Name <- recode(ipo.data$Name, !!!shortnames)

greekify <- function(names) {
  names %>% 
    str_replace("^a-","\U03B1-") %>% str_replace("-a-","-\U03B1-") %>% 
    str_replace("^b-","\U03B2-") %>% str_replace("-b-","-\U03B2-") %>% 
    str_replace("^g-","\U03B3-") %>% str_replace("-g-","-\U03B3-")
}
```

# Check quant vs. qual integrations

```{r quant, fig.width=12}
ipo.all <- dcast(ipo.data, Filename~Name, sum, value.var="Area")
rownames(ipo.all) <- ipo.all[,1]
ipo.all[,1] <- NULL

#load quantitative integrations
quant <- read_tsv("data/volatiles/quant.tsv") %>%
  mutate(Name = recode(Name, !!!shortnames)) %>% 
  pivot_wider(names_from = "Name", values_from="Area") %>% as.data.frame()

quant.meta <- quant %>% select(batch, Dirname, Filename) %>% 
  mutate(isblank = str_detect(Filename, "lank"),
         Year = as.integer(str_match(Filename, "(201[7-9]|202[1-2])[_.]")[,2]),
         GCOrder = as.integer(str_match(Filename, "_([0-9][0-9]).qgd")[,2]),
         RunDate = str_remove(str_extract(Filename, paste0("_[0-9]{2,4}",Year)), "_[0]*"),
         RunDate = ymd(paste(str_sub(RunDate, -4,-1), str_sub(RunDate,1,1), str_sub(RunDate, 2, -5))))

rownames(quant) <- quant$Filename
quant[,c("batch","Dirname","Filename")] <- NULL
quant.all <- quant[rownames(ipo.all),]#TODO 64 missing files, tho might be filtered out later anyway

par(mfrow=c(4,8))
quant.slopes <- set_names(rep(0,ncol(quant.all)), colnames(quant.all))
for(compvol in colnames(quant.all)) {
  quant_wins <- sum(ipo.all[,compvol] == 0 & quant.all[,compvol] > 0, na.rm=T)
  qual_wins <-  sum(quant.all[,compvol] == 0 & ipo.all[,compvol] > 0, na.rm=T)
  nozeros <- bind_cols(select(ipo.all,qual=compvol), select(quant.all,quant=compvol)) %>% 
    filter(!(qual==0 | quant == 0))
  quant.slopes[compvol] = coef(lm(quant ~ 0 + qual, data=nozeros))["qual"]
  # plot(x=sqrt(ipo.all[,compvol]), y=sqrt(quant.all[,compvol]),
  #      main=compvol, sub = paste0("quant:qual ",quant_wins,":",qual_wins,
  #                                 " slope ",round(quant.slopes[compvol],3)),
  #      xlab="qual",ylab="quant")
  # abline(a=0, b=sqrt(quant.slopes[compvol]))
}
par(mfrow=c(1,1))

quant_betterthan_qual <- colnames(quant.all) #TODO may want to exclude some of these from bouquet filtering (used below)
 #  c("b-myrcene", "(Z)-b-ocimene","(E)-b-ocimene", "g-terpinene","methyl benzoate", "(3E)-4,8-dimethylnona-1,3,7-triene", "2-methylbenzonitrile", "indole", "petasitene", 
 # "trans-a-bergamotene","b-caryophyllene" ,"bergamotene","a-farnesene","pseudoionone")
write_tsv(enframe(quant.slopes) %>% left_join(enframe(shortnames, name="Name", value="name")),
          "data/volatiles/quant_slopes.tsv")

quant.scaled <- sweep(quant.all, 2, quant.slopes, FUN = '/')

ggplot(tibble(quant=quant.scaled$indole, qual=ipo.all$indole), aes(x=qual, y=quant)) + 
  geom_point(alpha=0.2) + scale_x_sqrt(limits=c(0,3e7)) + scale_y_sqrt() + 
  geom_abline(slope=1, intercept=0) + labs(title="Indole integrations",x="Qualitative",y="Quantitative")

quant.meta <- quant.meta %>% mutate(indole_quant = quant$indole/quant.slopes["indole"])

ggplot(quant.meta %>% drop_na(RunDate) %>% arrange(isblank), aes(y=indole_quant, x=RunDate, color=isblank)) +  
  facet_wrap(vars(Year), scales="free_x", nrow=1)+ 
  geom_point(size=0.5, alpha=0.5) + stat_summary(geom="line", fun="mean", size=1)+ scale_y_sqrt()+ theme_bw()+ theme(legend.position="top")+
  labs(x="GC run date", y="Quantitative indole integration", color="Markes blank?")
```

# Read metadata

```{r metadata}
#accounts for skips
verdicts <- read_tsv("data/volatiles/RMBL GC-MS Data Inventory - ipogc181921.tsv") %>% 
  select(Filename=FileName, sample, verdict, status, FullName) %>% 
  mutate(Folder = str_remove(dirname(FullName),"C:/GCMSsolution/Data/Project1/"), .keep="unused") %>% 
  mutate(sample = na_if(sample,"") %>% coalesce(Filename)) %>% #fill in samples with no change
  drop_na(sample) %>%  # when both Filename and Sample are NA
  filter(is.na(verdict) | verdict!="mismatched") %>% # fuzzy matching misassigned these to a Markes entry
  filter(!duplicated(Filename))  # a couple nonunique filenames
#TODO one verdict = skip-lookup but no qgb to look up last filename: OTC_Z3_190805_8102019_24.qgd

##### 2018 + 2019 | bb + GNA + SC  | OTC + Perc ######
# field metadata
perc <- read_csv("data/volatiles/CWu Ipomopsis Scent Metadata - Percivals2018_2019.csv")
otc <- read_csv("data/volatiles/CWu Ipomopsis Scent Metadata - OTC2018_2019.csv")  %>%  
  rename(temp=OI) %>% mutate(temp = recode(temp,"in"="warmed","out"="control"))
# manually split filenames and drop chromatograms that were redone
files <- read_tsv("data/volatiles/CWu Ipomopsis Scent Metadata - CWu_samples_text2.tsv") %>% 
  rename(temp=OI) %>% mutate(temp = recode(temp,"in"="warmed","out"="control")) %>% filter(is.na(Drop)) %>% 
  left_join(verdicts)
# merge metadata and filenames
perc2 <- left_join(perc,files, by=c("Date","DN","Tissue","Sample2"), suffix=c("",".f"))
otc2 <-  left_join(otc, files, by=c("Date","Site","temp","DN","Tissue","Sample2"), suffix=c("",".f")) %>% 
  mutate(PlantType = if_else(temp == "air", "air", PlantType))

###### 2021 | GNA + SC | OTC ######
# field metadata
sc21 <- read_tsv("data/volatiles/2021 Spring Creek Volatiles - 2021.tsv") %>% 
  mutate(PlantType=if_else(plant=="air", "air", "ten"))
gna21 <- read_tsv("data/volatiles/2021 GNA Volatiles - 2021.tsv") %>% 
  mutate(time="day", PlantType=if_else(plant=="air", "air", "agg"))
# automatically split filenames, manually edit, drop chromatograms that were redone, and read back in
# tibble(Filename = rownames(ipo.all)) %>% 
#   filter(str_detect(Filename, "2021"), 
#          str_detect(Filename, "SC_|GNA_")) %>%
#   separate(Filename, into=c("site","vial","sampledate","rundate","GCn"), sep="_", remove=FALSE, convert=TRUE) %>% 
#   mutate(GCn = str_remove(GCn, ".qgd")) %>% write_tsv("files21_auto.tsv")  
files21 <- read_tsv("data/volatiles/CWu Ipomopsis Scent Metadata - files21.tsv") %>% 
  mutate(rundate = ymd(paste("2021", str_sub(rundate,1,1), str_sub(rundate, 2, -5))),
         sampledate = ymd(sampledate)) %>% 
  filter(is.na(drop)) %>% #drop samples that were redone
  left_join(verdicts)
#TODO check that the presumed redos in files21 were actually leaks/skips
#merge metadata and filenames
otc21 <- bind_rows(SC=sc21, GNA=gna21, .id="site") %>% 
  left_join(files21, by=c("vial","site")) %>% 
  drop_na(plant) %>% # two contaminated traps, not used
  mutate(sampledate = as.character(sampledate),
         Year = 2021, Tissue = if_else(plant == "air", "air", "flower"), Expt="otc",
         location = recode(location,"inside"="warmed","outside"="control"),
         PlantID = paste0(chamber, plant)) %>% 
  rename(Site=site, Collector=observer, Date=date, DN=time, temp=location, Bag=bag, Pump=pump, End=end, Equil=equil, Duration=pumping,
         NumFlrs = flowers, NumBuds=buds, PumpID = pump_id, SoilVWC = VWC, Comments = notes, SampleDate=sampledate,
         RunDate=rundate,GCOrder=GCn)

####### 2021 | Maxfield | OTC  #######
#automatically split filenames. Filename2 accounts for skip
maxfiles <- read_csv("data/volatiles/filenames_metadata - filenames_metadata.csv") %>% 
  left_join(verdicts) %>% # checked that sample matches up with old Filename2
  mutate(Is2021 = str_detect(Filename,"_210")) %>% 
  filter(Maxfield==1 & Year=="2021") %>% 
  separate(Filename2, into=c("plantid","vial","date","rundate","sequence","ext"),remove=F) %>% 
  mutate(across(c(plantid, vial), na_if,"NA")) %>% 
  mutate(date = ymd(date), vial=as.character(vial),
         YearFilament = ifelse(date>ymd("2021-07-21"),"2021fil2","2021"))

#field metadata, joined with treatments
GCMS_metadata1 <- read_csv("data/volatiles/2021 Maxfield Volatiles - 2021.csv") %>% mutate(plotid=paste0(plot, subplot)) %>% 
  left_join(read_csv("data/2021 Maxfield Rosettes - 2021OTCs.csv") %>% mutate(plant=as.character(plant)),
            by=c("plotid","plant","plantid"))

#look up plant IDs for each GC tube (vial column also has A/B for multiple samples)
max21.oldformat <- bind_rows(
  left_join(maxfiles %>% filter(vial %in% c("A","B")), GCMS_metadata1, by=c("plantid","vial","date")),
  left_join(maxfiles %>% filter(!vial %in% c("A","B") & is.na(plantid)), GCMS_metadata1, by=c("vial","date")), #vial numbers only
  left_join(maxfiles %>% filter(!vial %in% c("A","B") &!is.na(plantid)), GCMS_metadata1, by=c("plantid","date"))) %>%  #plantid
  mutate(type=factor(ifelse(plant=="air","ambient","floral")), 
         temp=factor(temp.y), snow=factor(snow),
         plantid= coalesce(plantid, plantid.y)) 

#rename columns to match CWu metadata format
max21 <- max21.oldformat %>% #put in line with CWu metadata
  rename(Date=date, RunDate_text=rundate,
         Comments=notes, Collector=observer, Bag=bag, Pump=pump,End=end, 
         NumFlrs=flowers, NumBuds=buds, PumpID=pump_id, SoilVWC=VWC,
         PlantType=type, PlantID=plantid) %>% 
  mutate(vial=as.integer(recode(vial, "A"="1001", "B"="1002")),
         RunDate_text = as.integer(RunDate_text),
         PlantType=recode(PlantType, "ambient"="air", "floral"="agg"),
         Tissue=recode(PlantType, "agg"="flower"),
         Expt="otc",Site="Maxfield",DN="day",
         temp=recode(temp,"OTC"="warmed"))

######## Combine all metadata tables #########
meta <- bind_rows(otc=bind_rows(otc2, otc21, max21), perc=perc2, .id="expt") %>% 
  mutate_if(is.character, as.factor) %>%
  mutate(Equil=Pump-Bag, Duration=End-Pump, Total=End-Bag,
         Pump_datehour = paste(Date, Pump) %>% ymd_hms(tz="America/Denver") %>% round_date("hour"),
         Expt=expt) %>% #TODO sort thru Expt==NA
  #Add mean temperature of OTCs or controls at time of sampling
  left_join(read_csv("data/hobos_mean.csv") %>% select(-date) %>% 
              mutate(datetime = with_tz(datetime, "America/Denver")), #stored in UTC!
            by = c("Site"="site", "Pump_datehour"="datetime")) %>% 
  mutate(mean_temp_C_treatment = if_else(temp=="warmed", mean_temp_C_warmed, mean_temp_C_control))

meta %>% write.csv("data/volatiles/CWu_meta21.csv")

meta %>% count(Year, Temp, Tissue, PlantType, Site, temp, DN, Expt) %>% kable(caption="Sample size")

tempcol <- set_names(brewer.pal(3, "Set1")[c(2,1)], c("control", "warmed"))#OTCs
Tempcol <- set_names(brewer.pal(3, "Set1")[c(2,1)], c("cool", "warm"))#Percivals
```

## Missing files

```{r nofile}
#perc2 %>% filter(is.na(Filename)) %>% select("n") %>% write.csv("perc_nomatch.csv")
#otc2 %>% filter(is.na(Filename)) %>% select("n") %>% write.csv("otc_nomatch.csv")
meta %>% filter(is.na(Filename)) %>% #no filename
  filter(is.na(lost)) %>% # 2021 samples "lost" (to what?)
  filter(is.na(nomatch) | nomatch != "NR") %>% # samples not run
  select(1:16) %>% kable(caption = "have metadata, no chromatogram")# & nomatch!="NR"
#otc21 %>% filter(is.na(Filename), is.na(lost)) %>% select(1:18) %>% kable(caption = "have metadata, no chromatogram")
#max21 is not missing any files
meta %>% filter(!is.na(lost)) %>% select(1:16) %>% kable(caption = "have metadata, samples lost")
```

## Missing metadata

```{r nometa}
#files %>% filter(!(Filename %in% meta$Filename)) %>% select("n") %>% write.csv("CWu_samples_nomatch.csv")
files %>% filter(!(Filename %in% meta$Filename) & Expt!="") %>% select(c("Filename", "Date","Site","temp","DN","Tissue","Sample2")) %>% kable(caption = "have chromatogram, no metadata")
files21 %>% filter(!(Filename %in% meta$Filename)) %>% kable(caption = "have chromatogram, no metadata")
```

GNA_121 and SC_101 traps contaminated, no metadata for SC_140. maxfiles is not missing any metadata. \## Times

```{r times}
ggplot(meta, aes(x=paste(Expt, DN,Year), y=Pump, color=DN)) + 
  geom_boxplot() + geom_point()+
  theme_minimal() + theme(axis.text.x=element_text(angle=90))+ 
  ggtitle("Sampling time of day")

meta %>% group_by(Expt, DN, Tissue, Year) %>% drop_na(Pump) %>% 
  summarize(first=seconds_to_period(min(Pump)), last=seconds_to_period(max(Pump))) %>% kable(caption="Pump times")

ggplot(meta, aes(x=paste(Expt, Site, Year), y=Total/60, color=Tissue)) + 
  geom_point(position=position_dodge(width=0.3))+
  theme_minimal() + theme(axis.text.x=element_text(angle=90)) + 
  ggtitle("Total sampling duration")+
  ylab("Equilibration plus pumping time (min)")

```

## OTC actual temperature

```{r actualtemp}
ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(y=mean_temp_C_treatment, x=paste(Year, Site, temp), color=temp)) +
  facet_grid(cols=vars(DN), scales="free_x", space="free_x")+ 
  geom_boxplot(outlier.shape=NA)+ geom_point(alpha=0.2)+ 
  geom_path(aes(group=paste(Year, Site, Pump_datehour)), color="black", alpha=0.3)+
  theme_minimal() + theme(axis.text.x=element_text(angle=90)) + 
  scale_color_brewer(palette = "Set1", direction=-1)+
  labs(y="Mean hourly temperature (\u00B0C)", x=("Year, site"), color="Temperature")

ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(y=mean_temp_C_warmed, x=mean_temp_C_control, color=DN))+
  geom_abline(slope=1, intercept=0)+ geom_smooth(se=F)+
  geom_text(aes(label=round(mean_temp_C_warmed-mean_temp_C_control)), alpha=0.2)+ theme_minimal() +
  labs(x= "Mean temperature, controls (\u00B0C)", y="Mean temperature, warmed (\u00B0C)", color="Time")

ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(y=mean_temp_C_warmed-mean_temp_C_control, x=hour(Pump), color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
    labs(x= "Time of day", y="Temperature difference (\u00B0C)", color="Time")

meta %>% filter(Expt=="otc", temp !="air", Site != "bb") %>% 
  mutate(mean_temp_C_diff = mean_temp_C_warmed-mean_temp_C_control) %>% 
  group_by(DN) %>% summarize(mean_temp_C_diff.SD = sd(mean_temp_C_diff, na.rm=T), 
                             mean_temp_C_diff = mean(mean_temp_C_diff, na.rm=T)) %>% 
  kable(caption="temp difference during sampling")

ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(y=mean_temp_C_warmed-mean_temp_C_control, x=mean_temp_C_control, color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
      labs(x= "Mean temperature, controls (\u00B0C)", y="Temperature difference (\u00B0C)", color="Time")

ggplot(meta %>% filter(Expt=="otc", temp !="air", Site != "bb"), 
       aes(x=hour(Pump), y=mean_temp_C_control, color=DN))+
  geom_point(alpha=0.1)+geom_smooth(aes(group=paste(Site, Year, DN)), se=F, method="lm")+ theme_minimal() +
  scale_x_continuous(n.breaks=20) +
      labs(x= "Time of day", y="Temperature in controls (\u00B0C)", color="Time")
```

# Filtering criteria

## Flowers

```{r filtering, fig.height=12, fig.width=12}
sv <- meta %>% drop_na(Filename)
#ipo.gc <- ipo.all[sv$Filename,]

library(bouquet)
ipo.data.cut <- ipo.data[ipo.data$Filename %in% sv$Filename,]
ipo.data.cut$Filename <- sv$Filename[match(ipo.data.cut$Filename, sv$Filename)]
ipo.data.cut <- ipo.data.cut[ipo.data.cut$Name != "", ] #drop unidentified peaks
ipo.data.cut$Name <- droplevels(ipo.data.cut$Name)
longdata <- load_longdata(ipo.data.cut, sample="Filename", RT="Ret.Time", name="Name", area="Area", match = "SI", maxmatch=100)
metadata <- sv %>% as.data.frame() %>% #tibbles break bouquet's add_count_freqs
  rename(thesample=sample) %>% #name conflict with bouquet
  mutate(Tissue = fct_recode(Tissue, ambient="air", floral="flower", leaf="leaf"),
         PlantType = factor(if_else(Tissue=="leaf",paste0(PlantType,Tissue), as.character(PlantType)))) %>% 
  load_metadata(date="Date", sample="Filename", group="PlantType", type="Tissue")
vol.all <- make_sampletable(longdata, metadata)
chems <- make_chemtable(longdata, metadata)

### Flower filtering
chemsf <- chems %>%
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.1, group = TRUE) %>% #now filter separately for each species
  filter_contaminant(cont.list = c("Hexyl chloroformate", "Disulfide, di-tert-dodecyl",
                                   "2,2,4-Trimethyl-1,3-pentanediol diisobutyrate", 
                                   "2,4,6-trimethyloctane", 
                                   "Decane, 3,8-dimethyl-",    "Ethanone, 1-cyclopentyl-", 
                                   "o-Xylene",
                                   "3,5-dimethyloctane","2-hexyldecan-1-ol",
                                   "nonylcyclopropane","nonyl prop-1-en-2-yl carbonate",
                                   "(2E)-2,7-dimethylocta-2,6-dien-1-ol")) %>% #a quant integration that coelutes with b-myrcene
  filter_area(min_maximum = 1e6) %>% 
  filter_ambient_ratio(vol.all, metadata, ratio = 3) %>%
  combine_filters() 
chemsf$filter_final <- with(chemsf, (filter_RT == "OK" & filter_match =="OK" & 
                              (filter_freq.agg == "OK" | filter_freq.ten =="OK") & 
                              filter_area == "OK" & filter_contaminant == "OK") | 
                              name %in% c("indole"))#quant_betterthan_qual #manually include indole (rare)

#now run t-tests after rarity filtering
#don't filter by ambient ratio first, see paper on problems: https://doi.org/10.1186/1471-2105-11-450
chemsf <- bind_rows(chemsf %>% filter(filter_final) %>% 
  filter_ambient_ttest(prune_sampletable(vol.all, chemsf, metadata), 
                       metadata, alpha = 0.05, adjust = "fdr"), 
  chemsf %>% filter(!filter_final)) %>% 
  mutate(filter_ambient_ttest=fct_na_value_to_level(filter_ambient_ttest, "notchecked"),
         filter_final = filter_final & filter_ambient_ratio =="OK") %>% 
  arrange(match(name, colnames(vol.all)))

bouquet::plot_filters(chemsf, option="rarity", yrange=3.5)
bouquet::plot_filters(chemsf, option="ambient", yrange=2.5)
bouquet::plot_filters(chemsf, option="volcano", yrange=2.5, alpha_excluded = 0.5)
bouquet::plot_filters(chemsf, option="prop")
```

### Retention times

```{r retention, fig.width=12}
longdata.RT <- longdata %>% filter(name %in% chemsf$name[chemsf$filter_final]) %>% 
  left_join(select(metadata, sample, Year)) %>%
  group_by(name) %>%  mutate(n=n(), RT.sd=sd(RT)) %>% ungroup() %>% 
  mutate(name=fct_reorder(name, RT))

RT.year <- longdata.RT %>% group_by(name, Year) %>% summarize(RT=median(RT)) %>% pivot_wider(names_from=Year, values_from=RT) %>% 
  mutate(mean1821 = (`2018`+`2021`)/2, diff1819=`2018`-`2019`, diff1921=`2019`-`2021`,
         mean1821 = replace_na(mean1821, `2019`))

RT.tol <- 0.17  # 10 seconds before or after in quantitative params
ggplot(longdata.RT, aes(x=RT, y=name,color=RT.sd)) + geom_point(position=position_jitter(width=0, height=0.5)) + 
  scale_color_viridis_c(option="magma") + theme_dark()+
  geom_text(aes(x=4.5, label=n), color="grey80") +
  stat_summary(fun="median", fun.max=~median(.x)+RT.tol, fun.min=~median(.x)-RT.tol, geom="pointrange", color="white", size=0.5, shape=15)

ggplot(longdata.RT,  aes(y=RT, x=factor(Year), color=RT.sd)) + 
  facet_wrap(vars(name), scales="free_y") + geom_boxplot() + scale_color_viridis_c(option="magma") + theme_dark() +
  geom_pointrange(data=RT.year, aes(y=mean1821, ymin=mean1821-0.1, ymax=mean1821+0.1, x="2019"), color="blue")

#RT fixes
longdata.bergamotene <- longdata %>% filter(str_detect(name , "bergamotene")) %>% 
    left_join(select(metadata, sample, Year)) 
ggplot(longdata.bergamotene, aes(x=RT, fill=factor(Year))) + geom_histogram(binwidth=0.02) + 
  facet_wrap(vars(name), ncol=1) + scale_x_continuous(limits=c(NA,16))
longdata.bergamotene %>% filter(RT < 15) %>%  group_by(Year) %>% summarize(RT=median(RT)) %>% kable(digits=2)


longdata.butanoate <- longdata %>% filter(str_detect(name , "\\)-hex-3-enyl\\] butanoate")) %>% 
    left_join(select(metadata, sample, Year)) 
ggplot(longdata.butanoate, aes(x=RT, fill=factor(Year))) + geom_histogram(binwidth=0.02) + 
  facet_wrap(vars(name), ncol=1) + scale_x_continuous(limits=c(NA,NA))
longdata.butanoate %>% mutate(EZ=ifelse(RT>11, "Z","E")) %>% group_by(EZ, Year) %>% 
  summarize(RT=median(RT)) %>% kable(digits=2)
```

### Quant filtering

```{r filtering_quant, fig.width=12}
indole_quantqual <- left_join(quant.meta, 
                              bind_cols(metadata %>% select(Year, Folder, type, Expt, PlantType, DN, RunDate, Filename=sample),
                              indole_quant=quant.scaled[as.character(metadata$sample),"indole"], 
                              indole_qual=vol.all[as.character(metadata$sample),"indole"]) %>%
  mutate(GCOrder = as.integer(str_match(Filename, "_([0-9][0-9]).qgd")[,2]),
         Folder=str_remove(Folder,"Campbell RMBL Data/"))) %>% 
  mutate(type=coalesce(type, c("other","blank")[isblank+1]) %>% fct_relevel("other","blank"))
  
indole_quantqual %>% arrange(RunDate, GCOrder) %>%
  select(Year, Folder, type, Expt, PlantType, DN, Filename, 
         RunDate, GCOrder, indole_quant, indole_qual) %>% 
  write_tsv("~/Downloads/indole_quant_qual.tsv", na="")

typecols <- c(other="orange", blank="grey", ambient="blue",floral="red",leaf="limegreen")
ggplot(filter(indole_quantqual, type!="leaf"), aes(color=type, fill=type, x=indole_quant)) + 
  facet_wrap(vars(Year), ncol=1) + geom_density(alpha=0.1, size=0.7) + 
  geom_point(aes(y=0.07-as.integer(factor(type))/100), size=3, shape="|") +
  scale_x_sqrt() + coord_cartesian(ylim=c(0,0.06)) + theme_minimal() + theme(legend.position="top") +
  scale_color_manual(values=typecols) +  scale_fill_manual(values=typecols) + 
  labs(x="Quantitative indole integration", y="Density") 

ggplot(filter(indole_quantqual, type!="leaf") %>% drop_na(Year), aes(color=type, y=indole_quant, x=RunDate)) + 
  facet_wrap(vars(Year), nrow=1, scales="free_x") + geom_hline(yintercept=0) + geom_point(alpha=0.5) + 
  stat_summary(geom="line", fun="mean", size=1)+
  scale_y_sqrt()  + theme_bw()+ scale_x_date(guide = guide_axis(angle=90))+
  scale_color_manual(values=typecols) +
  labs(y="Quantitative indole integration", "Date of GC run") 
  
ggplot(indole_quantqual %>% filter(type!="leaf", Year!=2018), aes(color=type, y=indole_quant, x=GCOrder)) + 
  facet_wrap(vars(Year), nrow=1, scales="free_x") + geom_hline(yintercept=0) + geom_point(alpha=0.5) + 
  stat_summary(aes(group=paste(type)), geom="line", fun="mean", size=1.5)+
  scale_y_sqrt()  + theme_bw()+ 
  scale_color_manual(values=typecols)+
  labs(y="Quantitative indole integration", x="Order in GC run")

indole_quantqual %>% group_by(Year, type) %>% summarize(indole_quant=mean(indole_quant)) %>%
  pivot_wider(names_from="type",values_from=indole_quant) %>% 
  kable(caption="means", digits=0)

indole_quantqual %>% group_by(Year, type) %>% summarize(nonzero=mean(indole_quant>0)) %>%
  pivot_wider(names_from="type",values_from=nonzero) %>% 
  kable(caption="proportion indole detection (nonzero)", digits=3)
```

```{r calc_LoA, fig.width=11}
quant.scaled.meta <- left_join(quant.meta,  
                       bind_cols(metadata %>% select(Year, Folder, type, Expt, PlantType, DN, RunDate, Filename=sample),
                                 quant.scaled[as.character(metadata$sample),])) %>% 
  drop_na(type) %>% 
  pivot_longer(all_of(colnames(quant.scaled))) 

LoA.cutoff <- 0.8
quant.loa <- quant.scaled.meta %>%
  group_by(Year, type, name) %>% summarize(value=quantile(value, LoA.cutoff), .groups="drop")

ggplot(quant.loa, aes(y=fct_reorder(name, value, max), color=type, x=value, shape=factor(Year), group=factor(Year))) +
  geom_point(position=position_dodge(width=0.5)) + theme_minimal() +
  scale_x_sqrt() +  scale_color_manual(values=c("blue","red","green"))

quant.loa %>% pivot_wider(names_from=type, values_from=value) %>%
  ggplot(aes(x=floral/ambient, y=fct_reorder(name, floral/ambient, min)))  + 
  geom_point(aes(color=factor(Year), shape=name %in% (chemsf %>% filter(filter_final) %>% pull(name))), size=2) + 
  scale_x_log10() + scale_shape_manual(values=c(1, 19))+
  labs(x=paste0("Ratio of ",round(LoA.cutoff*100,0),"th percentile floral/ambient"), y="", color="Year", shape="Keep")

prop.above <- left_join(quant.scaled.meta %>% filter(type=="floral"),
          quant.loa %>% filter(type=="ambient") %>% rename(LoA=value) %>% select(-type)) %>% 
  group_by(Year, name) %>% summarize(above_LoA = mean(value > LoA),
                                     above_zero = mean(value > 0)) %>% 
  mutate(name=fct_reorder(name, above_LoA, max))

ggplot(prop.above %>%   pivot_longer(starts_with("above_"), names_to="limit"), 
       aes(y=name, x=value, color=limit, shape=factor(Year), group=limit)) + 
  geom_point(size=2, position=position_dodge(width=0.5)) + theme_minimal()

ggplot(prop.above, aes(x=above_zero, y=above_LoA, color=factor(Year))) + 
  geom_path(aes(group=name), color="grey90") + geom_text(aes(label=name)) +theme_minimal()
```

```{r checkpinene, eval=F}
ggplot(quant.scaled.meta %>% filter(name=="a-pinene"), aes(x=factor(Year), color=type, y=value)) + geom_boxplot() + scale_y_sqrt()  + scale_color_manual(values=c("blue","red","green")) + labs(title="quant")
ggplot(metadata, aes(x=factor(Year), color=type, y=vol.all$`a-pinene`)) + geom_boxplot() + scale_y_sqrt() + scale_color_manual(values=c("blue","red","green")) + labs(title="qual")
#ggplot(svf, aes(x=Year, y=vol$`a-pinene`)) + geom_boxplot(color="red") + scale_y_sqrt() + labs(title="qual or quant")
pinene_quantqual <- left_join(quant.meta, 
                              bind_cols(metadata %>% select(Year, Folder, type, Expt, PlantType, DN, RunDate, Filename=sample),
                              pinene_quant=quant.scaled[as.character(metadata$sample),"a-pinene"], 
                              pinene_qual=vol.all[as.character(metadata$sample),"a-pinene"]) )
ggplot(pinene_quantqual %>% filter(Year %in% c(2018, 2019,2021)), aes(x=pinene_qual, y=pinene_quant)) + geom_point() + facet_wrap(vars(Year))
```

## Leaves

```{r filtering_leaf, fig.height=12, fig.width=12}
### Leaf filtering
meta.leaf <- metadata %>% mutate(type = fct_recode(type, floral = "leaf", flower = "floral"))  #trick bouquet to think the leaf samples are floral TODO: hacky!
chems.leaf <- make_chemtable(longdata, meta.leaf) 
chemsf.leaf <- chems.leaf %>%
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.25, group = TRUE) %>%  #now filter separately for each species
  filter_contaminant(cont.list = c("Hexyl chloroformate","Acetic acid, trifluoro-, undecyl ester",
                                   "Hexylene glycol")) %>% 
  filter_area(min_maximum = 5e5) %>% 
  filter_ambient_ratio(vol.all, meta.leaf, ratio = 4) %>%
  combine_filters()
chemsf.leaf$filter_final <- with(chemsf.leaf, filter_RT == "OK" & filter_match =="OK" & 
                              (filter_freq.aggleaf == "OK" | filter_freq.tenleaf =="OK") & 
                              filter_area == "OK" &
                              filter_contaminant == "OK")
#TODO bouquet needs to do a one-sided t-test! some compounds lower in blanks got a pass with low p value!

chemsf.leaf <- bind_rows(chemsf.leaf %>% filter(filter_final) %>% 
  filter_ambient_ttest(prune_sampletable(vol.all, chemsf.leaf, metadata), 
                       metadata, alpha = 0.05, adjust = "fdr"), 
  chemsf.leaf %>% filter(!filter_final)) %>% 
  mutate(filter_ambient_ttest=fct_na_value_to_level(filter_ambient_ttest, "notchecked"),
         filter_final = filter_final & filter_ambient_ratio =="OK")  %>% 
  arrange(match(name, colnames(vol.all)))

bouquet::plot_filters(chemsf.leaf, option="rarity")
bouquet::plot_filters(chemsf.leaf, option="ambient", yrange=2.5)
bouquet::plot_filters(chemsf.leaf, option="volcano", yrange=2, alpha_excluded = 0.5)
bouquet::plot_filters(chemsf.leaf, option="prop")

#compare amounts in floral vs. leaf samples
chemsf <- chemsf %>% mutate(filter_ambient_leaf_ratio = chemsf.leaf$filter_ambient_ratio,
                            filter_ambient_leaf_ttest = chemsf.leaf$filter_ambient_ttest,
                            leaf_not_flower = filter_ambient_leaf_ratio=="OK" & filter_ambient_leaf_ttest=="OK" & 
                              !(filter_ambient_ratio=="OK" & filter_ambient_ttest=="OK"))

kept_either <- chemsf$filter_final | chemsf.leaf$filter_final
ggplot(chemsf[kept_either,], aes(x=mean.floral, y= chemsf.leaf[kept_either,"mean.floral"], label=name, color=paste(filter_final,chemsf.leaf[kept_either,"filter_final"], sep=", ")))+ theme_minimal()+
  geom_abline(slope=1, intercept=1) +   geom_point(aes(size=RT), alpha=0.3)+  geom_text()+ 
  scale_x_log10()+ scale_y_log10() + coord_fixed()+
  scale_color_manual(labels=c("leaf","floral","both"),values=c("darkgreen","red","blue"))+
  labs(x="Mean area in flowers", y= "Mean area in leaves", color="Kept in dataset")
```

## Pruning

```{r pruning}
vol <- prune_sampletable(vol.all, chemsf, metadata)
vol.leaf <- prune_sampletable(vol.all, chemsf.leaf, meta.leaf)

colnames(vol)[!colnames(vol) %in% shortnames]

names(head(sort(rowSums(vol>0)), 5))
files_exclude <- c("GNA_17_210716_7202021_18.qgd", "A188DAug16_09012018.qgd", "T196DAug16_09012018.qgd",
                   "T145DWarmAug10_08292018.qgd", "Maxfield_27_210723_822021_03.qgd", #filtered volatiles near zero
                   "SC_91_210715_8202021_10.qgd") #Artemisia leaves
#"OTC_Z2_leaf_190805_8102019_23.qgd" was excluded
files_exclude_leaf <- c("CWH1LeafJuly27_09022018.qgd","NatArea69leafrenamedJuly25_08312018.qgd", #lack leaf mass
                        "T164_leaf_190731_882019_18.qgd") #no filtered volatiles

svf <- metadata[metadata$type == "floral" & !(metadata$sample %in% files_exclude),]
svl <- metadata[metadata$type == "leaf" & !(metadata$sample %in% files_exclude_leaf),]

svf$Year <- factor(svf$Year)
svf <- svf %>% mutate_if(is.factor, droplevels) %>% 
  mutate(Treat = paste(temp, Temp) %>% 
           fct_collapse(control=c("control NA","NA cool"),warmed=c("NA warm","warmed NA")))
svl <- svl %>% mutate_if(is.factor, droplevels) %>% 
  mutate(Treat = paste(temp, Temp) %>% 
           fct_collapse(control=c("control NA","NA cool"),warmed=c("NA warm","warmed NA")))

vol <- vol[!(rownames(vol) %in% files_exclude) ,]
vol.leaf <- vol.leaf[!(rownames(vol.leaf) %in% files_exclude_leaf) ,]
```

```{r swapquant}
#TODO quant integrate these leaf volatiles: setdiff(colnames(vol.leaf), quant_betterthan_qual)

#quantitative integrations (scaled up to match qual integrations)
#this method only replaces compounds where the quant method did better than the qual method
quant.scaled.vol <- quant.scaled[rownames(vol), 
                                 colnames(quant.scaled) %in% 
                                   intersect(quant_betterthan_qual, colnames(vol))] 

#TODO found that E/Z isomers of b-ocimene were accurate underneath LoA, dropping this step for all but indole (the manual addition to the auto filtering)
# Subtract limit of ambient (LoA) from each compound/year
quant.loa.use <- left_join(tibble(name= colnames(quant.scaled.vol)),
                           quant.loa %>% filter(type=="ambient", name %in% quant_betterthan_qual) %>%
                             pivot_wider(names_from=Year, values_from=value))
# for(yr in levels(svf$Year)) {
#   thisyr <- svf$Year==yr
#   quant.scaled.vol[thisyr,] <- sweep(quant.scaled.vol[thisyr,], 2, pull(quant.loa.use, yr), FUN = '-')
# }

for(yr in levels(svf$Year)) {
  thisyr <- svf$Year==yr
  quant.scaled.vol[thisyr,"indole"] <- quant.scaled.vol[thisyr,"indole"] - (quant.loa.use %>% filter(name=="indole") %>% pull(yr))
}

#Set resulting negative values to zero
quant.scaled.vol[quant.scaled.vol<0] <- 0

#plot(x=unlist(sqrt(vol[,colnames(quant.scaled.vol)])), y=sqrt(unlist(quant.scaled.vol)), xlab="qual", ylab="quant")
# svf %>% as_tibble() %>% select(sample, Year, PlantType, Expt, DN) %>% 
#   bind_cols(indole_qual = vol$indole, indole_quant = quant.all[rownames(vol),]$indole) %>% 
#   filter(PlantType=="ten") %>% drop_na(PlantType) %>% 
#   arrange(Year, Expt, DN) %>% View()
#   write_tsv("~/Downloads/indole_quant_qual_comparison.tsv") %>% 
#   ggplot(aes(x=indole_qual, y=indole_quant/0.325))+geom_point() + geom_abline(slope=1, intercept = 0)

#swap in scaled and subtracted quant integrations
vol[,colnames(quant.scaled.vol)] <- quant.scaled.vol

# ggplot(bind_cols(vol, svf), aes(y=`indole`, x=`methyl benzoate`, col=Year)) + 
#   geom_point() + geom_smooth(se=F) + scale_x_sqrt(limits=c(0,1.1e6)) + scale_y_sqrt(limits=c(0,6e5)) + geom_rug() + 
#   geom_hline(data=quant.loa %>% filter(name=="indole", type=="ambient"), aes(yintercept=value, color=as.character(Year))) +
#   geom_vline(data=quant.loa %>% filter(name=="methyl benzoate", type=="ambient"), aes(xintercept=value, color=as.character(Year))) 

ggplot(bind_cols(vol, svf), aes(y=`(Z)-b-ocimene`, x=`(E)-b-ocimene`, color=Year)) + 
  geom_point() + geom_smooth(se=F) + scale_x_sqrt() + scale_y_sqrt() + geom_rug() + 
  geom_hline(data=quant.loa %>% filter(name=="(Z)-b-ocimene", type=="ambient"), aes(yintercept=value, color=as.factor(Year))) +
  geom_vline(data=quant.loa %>% filter(name=="(E)-b-ocimene", type=="ambient"), aes(xintercept=value, color=as.factor(Year)))

ggplot(bind_cols(vol, svf), aes(y=`trans-a-bergamotene`, x=`a-farnesene`, color=Year, shape=PlantType)) + 
  geom_point() + geom_smooth(aes(linetype=PlantType), se=F, span=1) + scale_x_sqrt() + scale_y_sqrt() + geom_rug()

ggplot(bind_cols(vol, svf), aes(y=`(1Z,4Z,7Z)-1,5,9,9-tetramethylcycloundeca-1,4,7-triene`, x=`b-caryophyllene`, color=Year)) + 
  geom_point() + geom_smooth(se=F, span=1) + scale_x_sqrt() + scale_y_sqrt() + geom_rug() +
  geom_hline(data=quant.loa %>% filter(name=="(1Z,4Z,7Z)-1,5,9,9-tetramethylcycloundeca-1,4,7-triene", type=="ambient"), aes(yintercept=value, color=as.factor(Year))) +
  geom_vline(data=quant.loa %>% filter(name=="b-caryophyllene", type=="ambient"), aes(xintercept=value, color=as.factor(Year)))
```


## Convert areas to mass

```{r convert_areas}
#Normalize emissions by equilibration and pumping time and sample
vol <- vol / as.numeric(svf$Total, units="hours") / svf$NumFlrs #30 min of equilibration plus 15 minpumping, one flower 
vol.leaf <- vol.leaf / as.numeric(svl$Total, units="hours") / svl$LeafDryWtGrams #area per hour per dry gram leaf

regressions <- read_csv("data/volatiles/regressions_181921_filtered_slopes.csv")
ggplot(regressions, aes(x=year, y=standard, fill=area_per_ng))+ geom_tile() + scale_fill_viridis_c() + geom_text(aes(label=paste0(round(area_per_ng/1000),"k"))) + labs(x="Year, filament",y="Standard",fill="Area per ng") + theme_minimal()

# convert peak areas to nanograms using standards run in each year
ipochemsf <- ipochems[match(colnames(vol), ipochems$shortname),]
svf$YearFilament <- coalesce(svf$YearFilament, svf$Year) #if_else(svf$Year=="2021" & date>ymd("2021-07-21"), "2021fil2", as.character(svf$Year))
for(yr in levels(svf$YearFilament)) {
  thisyr <- svf$YearFilament==yr
  #TODO these slopes are leading to most of the year effects. try using one year for now. 
  vol[thisyr,] <- sweep(vol[thisyr,], 2, pull(ipochemsf, paste0("area_per_ng","2019")), FUN = '/')
}
svf$Total <- rowSums(vol)

ipochemsl <- ipochems[match(colnames(vol.leaf), ipochems$shortname),]
vol.leaf <- sweep(vol.leaf, 2, ipochemsl$area_per_ng2019, FUN = '/')
svl$Total <- rowSums(vol.leaf)
```

## Ambient heatmap and NMDS

```{r heatmap_air, dev="png", dev.args=list(), fig.height=9, fig.width=12}
vol.pruned <- vol.all[,chemsf$filter_final]
metadata$zeroSum <- rowSums(vol.pruned)==0
vol.pruned <- vol.pruned[!metadata$zeroSum,]

ph  <- pheatmap(as.matrix(t(vol.pruned))^(1/3), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol.pruned, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=inferno(512),
         annotation_col = data.frame(metadata %>% filter(!zeroSum) %>% select("Year", "PlantType", "expt", "temp","DN","Site"), row.names=rownames(vol.pruned)), 
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
```

```{r nmds_air}
set.seed(1)
nmds.vol <- metaMDS(sqrt(vol.pruned), dist="bray", autotransform = FALSE, trace=F, trymax=3)
ordiplot(nmds.vol, type = "n")
text(nmds.vol, display="species", cex=0.7, col="grey20")
points(nmds.vol, display="sites", col=metadata$type, pch=as.integer(factor(metadata$Year)))
```

```{r diverse, eval=FALSE}
best <- list()
i <- 1
vol.left <- vol^(1/4) # halfway between areas and presence-absence
while(ncol(vol.left)>0) {
  print(dim(vol.left))
  best[[i]] <- which.max(rowSums(vol.left))
  vol.left <- vol.left[ , !decostand(vol.left[best[[i]],], method="pa"), drop=FALSE]
  i <- i+1
}
best.vol <- as.data.frame(t(vol[unlist(best),])) %>% rownames_to_column("name")

#get quant.ratios from ipo_gc.R
full_join(quant.ratios %>% mutate(name = shortnames[Name]), full_join(RT.year, best.vol)) %>% relocate(name) %>% 
  write_tsv("data/volatiles/quant_RT_ratios.tsv")
```

# All filtered samples

## Flower heatmap

```{r heatmap, dev="png", dev.args=list(), fig.height=9, fig.width=12}
#cairo_pdf("ipo_heatmap.pdf", width=12, height=12)
ph  <- pheatmap(as.matrix(t(decostand(vol, method="max")))^(1/3), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(decostand(vol, method="max"), method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=inferno(512),
         annotation_col = data.frame(svf %>% select("Year", "PlantType", "expt", "Treat","DN","Site"), row.names=rownames(vol)), 
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
#dev.off()
```

## Flower NMDS

```{r nmds_filtered}
set.seed(1)
nmds.vol <- metaMDS(sqrt(vol), dist="bray", autotransform = FALSE, trace=F, trymax=3)

TEY <- with(svf, factor(paste(PlantType,expt,Year)))
TEYcols <- brewer.pal(9, "Paired")#[c(1:4,8,5:6)]
spcols <- c(agg="red", ten="violet")
ordiplot(nmds.vol, type = "n")
text(nmds.vol, display="species", cex=0.7, col="grey20")
legend("topleft", levels(svf$DN), pch=c(1,4))
#legend("topright", levels(svf$PlantType), fill=spcols)
legend("bottomright", levels(svf$Year), fill=1:3)
#legend("bottomleft", levels(TEY), fill=TEYcols, cex=0.9)
#points(nmds.vol, display="sites", col=TEYcols[TEY], pch=c(13,19)[svf$DN])
#points(nmds.vol, display="sites", col=spcols[svf$PlantType], pch=c(13,19)[svf$DN])
points(nmds.vol, display="sites", col=svf$Year, pch=c(1,4)[svf$DN])
#points(nmds.vol, display="sites", col=viridis(100)[sqrt(rowSums(vol))/100], pch=19)
```

## Average composition

```{r comp, fig.width=14}
relamounts <- svf %>% select(expt, PlantType, DN) %>% 
  bind_cols(decostand(vol, method="tot")) %>% pivot_longer(all_of(colnames(vol))) %>%
  group_by(expt, PlantType, DN, name) %>% 
  summarize(mean=mean(value), se=sd(value)/sqrt(n())) %>% arrange(expt, PlantType, DN, desc(mean))

ggplot(relamounts, aes(y=fct_reorder(name, mean, base::mean), x=mean, color=paste(PlantType, expt), shape=DN))+ 
  geom_pointrange(aes(xmin=mean-se, xmax=mean+se), position=position_dodge2(width=0.4)) + 
  scale_shape_manual(values=c(1,19)) +   scale_x_sqrt(expand=c(0,0), labels=scales::percent_format())+ 
  labs(x="Mean percentage",y="",color="Species", shape="Time")+
  scale_color_manual(values=c("orange","red","cyan","blue")) + theme_dark()

relamounts %>% slice_head(n=6) %>% filter(expt=="otc") %>%  kable(digits=3)

absamounts <- svf %>% select(expt, PlantType, DN) %>% 
  bind_cols(vol) %>% pivot_longer(all_of(colnames(vol))) %>%
  group_by(expt, PlantType, DN, name) %>% 
  summarize(mean=mean(value), se=sd(value)/sqrt(n())) %>% arrange(expt, PlantType, DN, desc(mean))

ggplot(absamounts, aes(y=fct_reorder(name, mean, base::mean), x=mean, color=paste(PlantType, expt), shape=DN))+ 
  geom_pointrange(aes(xmin=mean-se, xmax=mean+se), position=position_dodge2(width=0.4)) + 
  scale_shape_manual(values=c(1,19)) +   scale_x_sqrt(expand=c(0,0))+ 
  labs(x="Mean nanograms per hour",y="",color="Species, experiment", shape="Time")+
  scale_color_manual(values=c("orange","red","cyan","blue")) + theme_dark()

absamounts %>% pivot_wider(names_from=DN, values_from=c(mean, se)) %>% 
  ggplot(aes(x=mean_day, y=mean_night)) +  
  geom_path(aes(group=name), color="grey") + geom_text(aes(label=name, color=paste(expt, PlantType))) +
  scale_x_log10() + scale_y_log10() + geom_abline(slope=1, intercept=0) + scale_color_manual(values=c(NA,"cornflowerblue","red","blue"))

absamounts %>% pivot_wider(names_from=DN, values_from=c(mean, se)) %>% drop_na(mean_night) %>% 
  mutate(dn_ratio = mean_night/mean_day, exptPlantType=paste(expt, PlantType, sep="_")) %>% 
  ungroup() %>% select(name, exptPlantType, dn_ratio, mean_night) %>% 
  pivot_wider(names_from=exptPlantType, values_from=c(mean_night,dn_ratio)) %>% arrange(desc(`mean_night_otc_ten`)) %>% kable(digits=1)

freqamounts <- svf %>% select(expt, PlantType, DN) %>% 
  bind_cols(decostand(vol, method="pa")) %>% pivot_longer(all_of(colnames(vol))) %>%
  group_by(expt, PlantType, DN, name) %>% 
  summarize(mean=mean(value), se=sd(value)/sqrt(n())) %>% arrange(expt, PlantType, DN, desc(mean))

ggplot(freqamounts, aes(y=fct_reorder(name, mean, base::mean), x=mean, color=paste(PlantType, expt), shape=DN))+ 
  geom_pointrange(aes(xmin=mean-se, xmax=mean+se), position=position_dodge2(width=0.4)) + 
  scale_shape_manual(values=c(1,19)) +   scale_x_continuous(expand=c(0,0))+ 
  labs(x="Frequency of detection",y="",color="Species, experiment", shape="Time")+
  scale_color_manual(values=c("orange","red","cyan","blue")) + theme_dark()
```

## Compare to Bischoff et al. 2014
```{r bischoff, fig.width=14, fig.height=14}
b14 <- read_tsv("data/volatiles/bischoff14_comparison.xlsx - S1B.tsv")
b14.long <- b14 %>% pivot_longer(contains("."), names_to="group") %>% 
  separate(group, c("species","site","DN","meanse")) %>% 
  pivot_wider(names_from = meanse)
ggplot(b14.long, aes(y=fct_reorder(name, mean, base::mean), x=mean, xmin=mean-se, xmax=mean+se, color=paste(species,site), shape=DN))+
  geom_pointrange(position=position_dodge2(width=0.9)) +  scale_x_sqrt(expand=c(0,0)) + scale_shape_manual(values=c(1,19)) +
  scale_color_manual(values=c("orange","red","pink","cyan","blue")) + theme_dark()

b14.long %>% pivot_wider(names_from=DN, values_from=c(mean, se)) %>% 
  ggplot(aes(x=sqrt(mean_day), y=sqrt(mean_night))) +  
  geom_path(aes(group=paste(name, species)), color="grey") + geom_text(aes(label=name, color=paste(species, site))) +
  scale_x_sqrt() + scale_y_sqrt() + geom_abline(slope=1, intercept=0) +
  scale_color_manual(values=c("orange","red","pink","cyan","blue")) + theme_dark()
```

# OTCs vs. Ambient

## Inventory

```{r otc}
svf %>% filter(expt=="otc") %>% count(PlantType, DN, temp,Year, Site, is.na(mean_temp_C_treatment)) %>% 
  pivot_wider(names_from=temp, values_from=n) %>%  kable(caption="Sample size")

samplesperplant <- svf %>% filter(Expt=="otc") %>% count(PlantType, DN, temp, Year, Site, PlantID)
samplesperplant %>% count(PlantType, DN, Year, Site, temp) %>%  pivot_wider(names_from=temp, values_from=n) %>% kable(caption="Number of plants")
samplesperplant %>% count(PlantType, DN, Year, Site, n) %>% kable(caption="Sample size per plant")
samplesperplant %>% ggplot(aes(x=n, fill=Site)) + facet_grid(Site ~ Year) + geom_histogram(binwidth=1) + 
  stat_bin(aes(label=stat(count)), y=3, geom="text", binwidth=1) + guides(fill="none") + theme_minimal()

ggplot(svf %>% filter(Expt=="otc") %>% mutate(site=paste(Site,DN))) + facet_wrap(vars(Year), ncol=1)+
  geom_bar(aes(x=yday(date), color=site, fill=site)) +
  geom_vline(data=read_csv("./data/CWu OTC Hobos - duration.csv") %>% 
    mutate(begin=OTC_start-days(1), end=OTC_end+days(1), #start/end were trimmed 1 day for hobos
           Year=year, site=paste(site,"day"), .keep="unused"), 
    aes(xintercept=yday(begin), color=site), size=1, linetype=2)+
  theme_minimal() + labs(x="Day of year", y="Number of floral volatile samples", color="Site", fill="Site")
  

plot.otc <- function(svf.otc, cap.terms=c("mean_temp_C_treatment", "temp"), plot.chems=T) {
  vol.otc <- vol[svf.otc$sample,]
  cap.formula <- reformulate(cap.terms, response = "sqrt(vol.otc)")
  cap.otc <- capscale(cap.formula, distance="bray", data=svf.otc)
  summ.cap <- summary(cap.otc)
  prop.expl <- summ.cap$cont$importance
  ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")
  cap.terms.int <- str_subset(cap.terms, ":")
  anova.cap <- anova(cap.otc, by=ifelse(length(cap.terms.int)>0, "term", "margin"))
  
  plot(cap.otc, type="n", xlim=range(cap.otc$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
  with(svf.otc, 
       title(main=paste("OTC warming:","I.",unique(PlantType), "at", paste(unique(Site), collapse=" & "),unique(Year),
                            do.call(paste0, list(unique(DN), collapse="/")), "n =",nrow(svf.otc))))
  if("temp" %in% cap.terms) legend("topleft", title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), 
                                   levels(svf.otc$temp), fill=tempcol)
  if("DN" %in% cap.terms) legend("topright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), 
                                 levels(svf.otc$DN), pch=c(1,19))
  if(length(cap.terms.int)>0) legend("bottomleft", title= paste("Interaction\nP =", anova.cap[cap.terms.int,"Pr(>F)"]), legend="")
  temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
  if("mean_temp_C_treatment" %in% cap.terms) legend("bottomleft", 
                                                    title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]),
                                                    paste(temprange, " C"), fill=rev(viridis(2)))
  if("Site" %in% cap.terms) legend("bottomright",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]),
                                   unique(svf.otc$Site))
  ordispider(cap.otc, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
  points(cap.otc, display="sites", col=c(tempcol)[svf.otc$temp], pch=c(1,19)[svf.otc$DN]) 
  text(cap.otc, display="cn")
  if(plot.chems) {
    if(length(cap.terms)>1) text(cap.otc, display="species", cex=0.8, srt=45,
                     col=ifelse(sqrt(cap.otc$CCA$v[,1]^2 + cap.otc$CCA$v[,2]^2)>0.25, alpha("purple",1),alpha("purple",0)))
    else text(cap.otc, display="species", cex=0.8, srt=45,
              col=ifelse(abs(cap.otc$CCA$v[,1])>0.1, alpha("purple",1),alpha("purple",0)))
  }
  return(cap.otc)
}

plot.terms <-c("mean_temp_C_treatment", "temp")
```

## CAP of *I. aggregata*

### Each year and site

```{r otc_agg}
cap.siteyr.agg <- svf %>% filter(expt=="otc", PlantType=="agg") %>% 
  drop_na(mean_temp_C_treatment) %>% 
  group_by(Site, Year) %>% summarize(meta = list(cur_data_all()), .groups = "drop") %>% 
  arrange(Site, Year) %>% #nest that keeps groups
  mutate(samples = map_int(meta, nrow),
         cap = map(meta, plot.otc),
         anova = map(cap, ~tidy(anova(.x, by="margin"))))

cap.siteyr.agg %>% select(-c(meta,cap)) %>% unnest(anova) %>% 
  filter(term!="Residual") %>% select(-c(df, SumOfSqs,statistic)) %>% 
  pivot_wider(names_from=term, values_from=p.value) %>% 
  rename(N=samples, Temperature=mean_temp_C_treatment, Treatment=temp) %>% 
  kable(caption="I. aggregata site-year CAP p-values")
```

### 2021 both sites

```{r otc_comb_year}
cap.yr.agg <- svf %>% filter(expt=="otc", PlantType=="agg", year == "2021") %>% 
  drop_na(mean_temp_C_treatment) %>% 
  group_by(Year) %>% summarize(meta = list(cur_data_all()), .groups = "drop") %>% 
  mutate(samples = map_int(meta, nrow),
         cap = map(meta, plot.otc, cap.terms=c(plot.terms, "Site")),
         anova = map(cap, ~tidy(anova(.x, by="margin"))))

cap.yr.agg %>% select(-c(meta,cap)) %>% unnest(anova) %>% 
  filter(term!="Residual") %>% select(-c(df, SumOfSqs,statistic)) %>% 
  pivot_wider(names_from=term, values_from=p.value) %>% 
  rename(N=samples, Temperature=mean_temp_C_treatment, Treatment=temp) %>% 
  kable(caption="I. aggregata year CAP p-values")
```

### All years

```{r otc_comb_temp, fig.height=6.5, fig.width=6.5}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="agg", Site!="bb") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year + mean_temp_C_treatment + temp + Site, distance="bray", data=svf.otc))

anova(cap.otc.comb, by="margin") %>% kable(caption="CAP")
prop.expl <- summary(cap.otc.comb)$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")
cap.df <- fortify(cap.otc.comb) 
arrowvars <- c(Temp="mean_temp_C_treatment", Warming="tempwarmed")
ggplot(mapping=aes(x=CAP1, y=CAP2, label=Label)) + 
  geom_path(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(group=paste(Year, Site, temp, PlantID)), color="grey60")+
  geom_point(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(shape=Year, color=mean_temp_C_treatment), size=3)+
  geom_segment(data=cap.df %>% filter(Score=="biplot", Label %in% arrowvars), aes(x=0,y=0,xend=CAP1*3.5, yend=CAP2*3.5), 
               arrow=arrow(length=unit(0.5, "lines")), color="white")+
  geom_text(data=cap.df %>% filter(Score=="biplot", Label %in% arrowvars)%>% mutate(Label=names(arrowvars)),
            aes(x=CAP1*3.6, y=CAP2*3.6, angle=atan(CAP2/CAP1)*180/pi, hjust=c(1,1)), fontface="bold", color="white", size=4) +
  geom_text(data=cap.df %>% filter(Score=="centroids") %>% mutate(Label=c("2018","2019","2021","","","GNA","Maxfield")),
            aes(x=CAP1, y=CAP2), fontface="bold", color="white", size=4) +
  geom_text_repel(data=cap.df %>% left_join(ipochems, by=c("Label"="name")) %>% mutate(Label=greekify(Label)) %>% 
                    filter(Score=="species", sqrt(CAP1^2+CAP2^2)>0.2), 
            aes(x=CAP1*1.5, y=CAP2*1.5), size=4, color="black", point.size=NA, box.padding=0)+ 
  scale_color_viridis_c("Temp (\u00B0C)", option="inferno", breaks=seq(0, 60, by=4)) + 
  scale_shape_manual(values=c(`2018`=15,`2019`=19,`2021`=17)) +  labs(x=ax.labs[1], y=ax.labs[2])+
  coord_fixed() + theme_bw() + 
  theme(panel.grid = element_blank(), panel.background = element_rect(fill="grey70"), axis.text = element_text(color="black"))

lmer(sqrt(Total) ~ Year + Site + temp + (1|PlantID), data = svf.otc) %>% anova %>% kable(caption="total emissions")
```

## CAP of *I. tenuituba*

### Each year

```{r otc_ten}
cap.yr.ten <- svf %>% filter(expt=="otc", PlantType=="ten") %>% 
  group_by(Year) %>% summarize(meta = list(cur_data_all()), .groups = "drop") %>% 
  mutate(samples = map_int(meta, nrow),
         cap = map(meta, plot.otc, cap.terms=c("DN","temp","DN:temp")),
         anova = map(cap, ~tidy(anova(.x, by="term"))))

cap.yr.ten %>% select(-c(meta,cap)) %>% unnest(anova) %>% 
  filter(term!="Residual") %>% select(-c(df, SumOfSqs,statistic)) %>% 
  pivot_wider(names_from=term, values_from=p.value) %>% 
  rename(N=samples, Time=DN, Treatment=temp, "Time:Treatment"="DN:temp") %>% 
  kable(caption="I. tenuituba year CAP p-values")
```

### Both years, day

```{r otc_comb_temp_tenD, fig.height=5, fig.width=8}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten", DN=="day") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year + mean_temp_C_treatment + temp, distance="bray", data=svf.otc))
anova(cap.otc.comb, by="margin") %>% kable(caption="CAP")
prop.expl <- summary(cap.otc.comb)$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")
cap.df <- fortify(cap.otc.comb) 
ggplot(mapping=aes(x=CAP1, y=CAP2, label=Label)) + 
  geom_path(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(group=paste(Year, Site, temp, PlantID)), color="grey60")+
  geom_point(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(shape=Year, color=mean_temp_C_treatment), size=3)+
  geom_segment(data=cap.df %>% filter(Score=="biplot", Label %in% arrowvars), aes(x=0,y=0,xend=CAP1*2.5, yend=CAP2*2.5), 
               arrow=arrow(length=unit(0.5, "lines")), color="white")+
  geom_text(data=cap.df %>% filter(Score=="biplot", Label %in% arrowvars) %>% mutate(Label=names(arrowvars)),
            aes(x=CAP1*2.6, y=CAP2*2.6, angle=atan(CAP2/CAP1)*180/pi, hjust=c(1,1)), fontface="bold", color="white", size=4) +
  geom_text(data=cap.df %>% filter(Score=="centroids") %>% mutate(Label=c("2019","2021","","")),
            aes(x=CAP1, y=CAP2), fontface="bold", color="white", size=4) +
  geom_text_repel(data=cap.df %>% left_join(ipochems, by=c("Label"="name")) %>% mutate(Label=greekify(Label)) %>% 
                    filter(Score=="species", sqrt(CAP1^2+CAP2^2)>0.2), 
            aes(x=CAP1*4, y=CAP2*4), size=4, color="black", point.size=NA, box.padding=0)+ 
  scale_color_viridis_c("Temp (\u00B0C)", option="inferno", breaks=seq(0, 60, by=4)) + 
  scale_shape_manual(values=c(`2018`=15,`2019`=19,`2021`=17)) +  labs(x=ax.labs[1], y=ax.labs[2])+
  coord_fixed() + theme_bw() +
  theme(panel.grid = element_blank(), panel.background = element_rect(fill="grey70"), axis.text = element_text(color="black"))

lmer(sqrt(Total) ~ Year + temp + (1|PlantID), data = svf.otc) %>% anova %>% kable(caption="total emissions")
```

### Both years, night

```{r otc_comb_temp_tenN, fig.height=6.5, fig.width=6.5}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten", DN=="night") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year + mean_temp_C_treatment + temp, distance="bray", data=svf.otc))
anova(cap.otc.comb, by="margin") %>% kable(caption="CAP")
prop.expl <- summary(cap.otc.comb)$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")
cap.df <- fortify(cap.otc.comb) 
ggplot(mapping=aes(x=CAP1, y=CAP2, label=Label)) + 
  geom_path(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(group=paste(Year, Site, temp, PlantID)), color="grey60")+
  geom_point(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(shape=Year, color=mean_temp_C_treatment), size=3)+
  geom_segment(data=cap.df %>% filter(Score=="biplot", Label %in% arrowvars), aes(x=0,y=0,xend=CAP1*2.6, yend=CAP2*2.6), 
               arrow=arrow(length=unit(0.5, "lines")), color="white")+
  geom_text(data=cap.df %>% filter(Score=="biplot", Label %in% arrowvars) %>% mutate(Label=names(arrowvars)),
            aes(x=CAP1*2.7, y=CAP2*2.7, angle=atan(CAP2/CAP1)*180/pi, hjust=c(1,0)), fontface="bold", color="white", size=4) +
  geom_text(data=cap.df %>% filter(Score=="centroids") %>% mutate(Label=c("2019","2021","","")),
            aes(x=CAP1, y=CAP2), fontface="bold", color="white", size=4) +
  geom_text_repel(data=cap.df %>% left_join(ipochems, by=c("Label"="name")) %>% mutate(Label=greekify(Label)) %>% 
                    filter(Score=="species", sqrt(CAP1^2+CAP2^2)>0.2), 
            aes(x=CAP1*3, y=CAP2*3), size=4, color="black", point.size=NA, box.padding=0)+ 
  scale_color_viridis_c("Temp (\u00B0C)", option="inferno", breaks=seq(0, 60, by=4)) + 
  scale_shape_manual(values=c(`2018`=15,`2019`=19,`2021`=17)) +  labs(x=ax.labs[1], y=ax.labs[2])+
  coord_fixed() + theme_bw() + 
  theme(panel.grid = element_blank(), panel.background = element_rect(fill="grey70"), axis.text = element_text(color="black"))

lmer(sqrt(Total) ~ Year + temp + (1|PlantID), data = svf.otc) %>% anova %>% kable(caption="total emissions")
```

### 2021, night, VWC

```{r otc_comb_VWC_tenN}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten", DN=="night") %>% drop_na(SoilVWC)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ temp + SoilVWC, distance="bray", data=svf.otc))
anova.cap <- anova(cap.otc.comb, by="margin")
kable(anova.cap, caption="CAP tenuituba night - treatment")

svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten", DN=="night") %>% drop_na(SoilVWC, mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ mean_temp_C_treatment + SoilVWC, distance="bray", data=svf.otc))
anova.cap <- anova(cap.otc.comb, by="margin")
kable(anova.cap, caption="CAP tenuituba night - temperature")
```

### All years, day and night

```{r otc_comb_ten}
svf.otc <- svf %>% filter(expt=="otc", PlantType=="ten")
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year * DN + temp, distance="bray", data=svf.otc))
anova(cap.otc.comb, by="term") %>% kable(caption="CAP")
prop.expl <- summary(cap.otc.comb)$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")
cap.df <- fortify(cap.otc.comb) 
ggplot(mapping=aes(x=CAP1, y=CAP2, label=Label)) + 
  geom_path(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(group=paste(Year, Site, temp, PlantID, week(date)), color=temp))+
  geom_point(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(shape=paste(Year,DN), color=temp), size=3)+
  geom_segment(data=cap.df %>% filter(Score=="biplot"), aes(x=0,y=0,xend=CAP1*1.8, yend=CAP2*1.8), 
               arrow=arrow(length=unit(0.5, "lines")), color="white")+
  geom_text(data=cap.df %>% filter(Score=="biplot") %>% mutate(Label=c("2021","Night","Warming","2021:night")),
            aes(x=CAP1*1.9, y=CAP2*1.9, angle=atan(CAP2/CAP1)*180/pi, hjust=0), fontface="bold", color="white", size=5) +
  geom_text_repel(data=cap.df %>% left_join(ipochems, by=c("Label"="name")) %>% filter(Score=="species", sqrt(CAP1^2+CAP2^2)>0.28), 
            aes(x=CAP1*0.8, y=CAP2*0.8), size=4, color="black", point.size=NA, box.padding=0)+  labs(x=ax.labs[1], y=ax.labs[2])+
  scale_color_manual("Treatment", values=tempcol)+ scale_shape_manual("Year, time", values=c(0,15,1,19))+
  coord_fixed() + theme_bw() + theme(panel.grid = element_blank(), panel.background = element_rect(fill="grey70"))

lmer(sqrt(Total) ~ Year * DN + temp + (1|PlantID), data = svf.otc) %>% anova %>% kable(caption="total emissions")
```


## Both species, day

```{r otc_both_species}
svf.otc <- svf %>% filter(expt=="otc", DN=="day", Site!="bb") %>% drop_na(mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year + Site + mean_temp_C_treatment + temp, distance="bray", data=svf.otc))
(anova.cap <- anova(cap.otc.comb, by="margin"))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("OTC warming: I. agg & ten at all sites, all years, day","n =", nrow(svf.otc)))
temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
legend("topleft",  title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]), legend=paste(temprange, " C"), fill=rev(viridis(2)))
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), levels(svf.otc$Year), pch=yearpch)
legend("bottomright",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]), legend=unique(svf.otc$Site))
legend("bottomleft",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp))
ordispider(cap.otc.comb, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
points(cap.otc.comb, display="sites", col=inferno(round(temprange[1]-temprange[2])+1)[round(svf.otc$mean_temp_C_treatment-temprange[2])+1], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("red",0.7),alpha("red",0)))

lmer(sqrt(Total) ~ Year + Site + temp + (1|PlantID), data = svf.otc) %>% anova %>% kable(caption="total emissions")
```

## 2021 by week

```{r otc_week}
#Night, tenuituba
svf.otc <- svf %>% filter(expt=="otc", DN=="night", Year=="2021") %>% 
  mutate(sampround = factor(ifelse(yday(date)>200, "4wks", "2wks")))
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ sampround * temp, distance="bray", data=svf.otc))
anova.cap <- anova(cap.otc.comb, by="term")
kable(anova.cap, caption="CAP tenuituba 2021 night by week")

#Day, both species
svf.otc <- svf %>% filter(expt=="otc", DN=="day", Year=="2021") %>% 
  mutate(sampround = factor(ifelse(yday(date)>200, "4wks", "2wks")))
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Site + sampround * temp, distance="bray", data=svf.otc))
anova.cap <- anova(cap.otc.comb, by="term")
kable(anova.cap, caption="CAP both species day by week")
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Site + sampround + temp, distance="bray", data=svf.otc))
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("OTC warming, week: I. agg & ten at all sites, 2021, day","n =", nrow(svf.otc)))
legend("bottomright",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]), legend=unique(svf.otc$Site))
legend("bottomleft",  title=paste("Treatment","\nP =",anova.cap["temp","Pr(>F)"]), levels(svf.otc$temp))
legend("topleft",  title=paste("Week","\nP =",anova.cap["sampround","Pr(>F)"]), levels(svf.otc$sampround), pch=c(1,2))
ordispider(cap.otc.comb, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
points(cap.otc.comb, display="sites", col=tempcol[svf.otc$temp], pch=as.integer(svf.otc$sampround))
text(cap.otc.comb, display="cn")
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
```

## Both species, VWC+temp, day

```{r otc_both_species_VWC_temp}
svf %>% mutate(hasVWC=!is.na(SoilVWC+mean_temp_C_treatment)) %>% filter(Expt=="otc")%>% count(Year, Site, DN, hasVWC) %>% pivot_wider(names_from=hasVWC, values_from=n) %>%   kable(caption="VOC samples with soil moisture and temp")

svf.otc <- svf %>% filter(expt=="otc", DN=="day", Site!="bb") %>% drop_na(SoilVWC, mean_temp_C_treatment)
vol.otc <- vol[svf.otc$sample,]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ Year + Site + SoilVWC + mean_temp_C_treatment, distance="bray", data=svf.otc))
anova.cap <- anova(cap.otc.comb, by="margin")
kable(anova.cap, caption="CAP both species, soil moisture and temperature")
summ.cap <- summary(cap.otc.comb)
prop.expl <- summ.cap$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")

yearpch <- c(`2018`=15,`2019`=19,`2021`=17)
plot(cap.otc.comb, type="n", xlab=ax.labs[1], ylab=ax.labs[2])
title(paste("Soil moisture + temperature: I. agg & ten at all sites, all years","n =", nrow(svf.otc)))
VWCrange <- round(c(max(svf.otc$SoilVWC), min(svf.otc$SoilVWC)))
legend("left",  title=paste("VWC","\nP =",anova.cap["SoilVWC","Pr(>F)"]), legend=paste(VWCrange, "%"), fill=rev(viridis(2)))
legend("topright",  title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), levels(svf.otc$Year), pch=yearpch)
legend("bottomleft",  title=paste("Site","\nP =",anova.cap["Site","Pr(>F)"]), legend=unique(svf.otc$Site))
temprange <- round(c(max(svf.otc$mean_temp_C_treatment), min(svf.otc$mean_temp_C_treatment)))
legend("topleft",  title=paste("Temperature","\nP =",anova.cap["mean_temp_C_treatment","Pr(>F)"]), legend=paste(temprange, " C"))
ordispider(cap.otc.comb, with(svf.otc, paste(Year, Site, temp, PlantID)), col="grey80")
points(cap.otc.comb, display="sites", col=viridis(round(VWCrange[1]-VWCrange[2])+1)[round(svf.otc$SoilVWC-VWCrange[2])+1], pch=yearpch[svf.otc$Year]) 
text(cap.otc.comb, display="cn")
text(cap.otc.comb, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.otc.comb$CCA$v[,1]^2 + cap.otc.comb$CCA$v[,2]^2)>0.25, alpha("red",1),alpha("red",0)))

ggplot(svf.otc, aes(x=mean_temp_C_treatment, y=SoilVWC))+ geom_point() + geom_smooth()
```

## Selection gradients

Following method of [Chong et al. 2018](https://doi.org/10.1002/evl3.63) for reconstructing selection estimates from estimates of selection on PCs: Beta = E \* A.

```{r gradients, fig.height=6}
minsamples <- 70
vol.top <- vol[,colSums(decostand(vol,"pa"))> minsamples]#occur in more than minsamples

sds <- read_csv("data/2021_Maxfield_sds.csv") %>% 
  mutate(prop_uninfested = 1 - prop_infested, 
         plant=as.character(plant))

fitnesstraits <- c("seeds_est", "seeds_per_flower", "prop_uninfested") #"eggs_per_flower"
fitnessnames <- set_names(c("Estimated total seeds", "Estimated seeds per flower", "Prop. nonaborted fruits uninfested"), fitnesstraits)

# Run PCA on traits
vols.PCA <- vol.top %>% mutate(across(everything(), ~ (.x-mean(.x, na.rm=T))/sd(.x, na.rm=T))) %>% 
  prcomp() 
summary(vols.PCA) # PCs 1 - 5 explain 63% of the variation, #PCs total = top volatiles
vols.PCA.E <- vols.PCA$rotation[,1:5] #min(4, ncol(vols.PCA$rotation))

calculate_beta <- function(E, slopes) {
  data.frame(B = E %*% slopes$A,
             SE = sqrt(E ^ 2 %*% slopes$SE ^ 2)) %>% 
    mutate(not_zero = abs(B) - SE > 0) %>% 
    rownames_to_column("trait")
}

selection_pca <- function(temp=c("control","warmed"), fitnesstrait = "seeds_est") {
  vols.std.PCA <- svf %>% bind_cols(as.data.frame(vols.PCA$x)) %>% 
    filter(temp %in% .env$temp) %>% 
    mutate(plant=as.character(plant)) %>% 
    left_join(sds, by=c("plotid", "plant","temp")) %>% 
    select(all_of(fitnesstrait), "temp", starts_with("PC")) %>% 
    rename("fitness" = fitnesstrait) %>% 
    mutate(relfitness = fitness/mean(fitness, na.rm=T), .keep="unused") %>% ungroup %>% 
    drop_na(relfitness) %>% 
    select(where(~sum(is.na(.))==0))
  
  # Regress relative fitness on PCs
  vols.PCA.regression <- lm(relfitness ~ PC1 + PC2 + PC3 + PC4 + PC5, data = vols.std.PCA)
  vols.PCA.slopes <- tidy(vols.PCA.regression) %>% filter(term != "(Intercept)") %>% rename(A=estimate, SE=std.error)
  
  # Convert selection gradients on PCs to gradients on traits
  calculate_beta(vols.PCA.E, vols.PCA.slopes)
}

plot_beta <- function(betas) {
  bs <- betas %>% left_join(ipochems, by=c("trait"="name")) %>% 
    mutate(trait = fct_reorder(trait, map_dbl(vol.top[,trait], mean)))#order graph by mean emissions
  ggplot(bs, aes(y=trait, x = B, xmin=B-SE, xmax=B+SE)) + 
    geom_vline(xintercept=0)+ 
    geom_pointrange(aes(color=temp), position=position_dodge(width=0.5)) + 
    labs(x = "Selection gradient (beta) estimated from PCs", y = "",   color="Temperature") +
    scale_color_manual(values=tempcol) + theme_minimal() + #+ scale_x_continuous(limits=c(-0.55,0.55), n.breaks=10)  +
    theme(legend.position="bottom")
}

vols.beta.temp <- expand_grid(temp=c("control","warmed"),  fitnesstrait=fitnesstraits)  %>% 
  mutate(betas = pmap(., selection_pca)) %>% unnest(betas)

walk(fitnesstraits, ~print(plot_beta(filter(vols.beta.temp, fitnesstrait==.x)) + ggtitle(fitnessnames[.x])))
```

# Percivals warm vs. cool

## CAP analysis of each Percival dataset

```{r perc}
#inventory of samples
svf %>% filter(expt=="perc") %>%  count(PlantType, DN, Temp,Year) %>% kable(caption="Sample size")

plot.perc <- function(svf.perc, plot.chems=T) {
    vol.perc <- vol[svf.perc$sample,]
    cap.perc <- capscale(sqrt(vol.perc) ~ DN+Temp, distance="bray", data=svf.perc)
    summ.cap <- summary(cap.perc)
    prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
    ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
    anova.cap <- anova(cap.perc, by="margin")
    
    plot(cap.perc, type="n", xlim=range(cap.perc$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
    with(svf.perc, title(paste0("Percivals: I. ", unique(PlantType)," in ", unique(Year), " n = ", nrow(svf.perc))))
    #, " (",round(100*summ.cap$constr.chi / summ.cap$tot.chi),"% explained)")
    legend("topleft", title=paste("Temperature","\nP =",anova.cap["Temp","Pr(>F)"]), 
           levels(svf.perc$Temp), fill=Tempcol)
    legend("topright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), 
           levels(svf.perc$DN), pch=c(1,19))
    if(plot.chems) text(cap.perc, display="species", cex=0.7, srt=45,
                     col=ifelse(sqrt(cap.perc$CCA$v[,1]^2 + cap.perc$CCA$v[,2]^2)>0.25, alpha("purple",0.7),alpha("purple",0)))
    ordispider(cap.perc, with(svf.perc, paste(Year, Temp, Sample2)), col="grey80")
    points(cap.perc, display="sites", col=Tempcol[svf.perc$Temp], pch=c(1,19)[svf.perc$DN]) 
    text(cap.perc, display="cn")
    return(cap.perc)
}
cap.perc.agg18 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2018",PlantType=="agg"))
cap.perc.agg19 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2019",PlantType=="agg"))
cap.perc.ten18 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2018",PlantType=="ten"))
cap.perc.ten19 <-  plot.perc(svf %>% filter(expt=="perc",Year=="2019",PlantType=="ten"))
#cap.perc.all <- list(agg18=cap.perc.agg18, agg19=cap.perc.agg19, ten18=cap.perc.ten18, ten19=cap.perc.ten19)
#lapply(cap.perc.all, anova, by="margin")
```

## CAP of Percival dataset combined for each species

```{r perc_comb}
plot.perc.comb <- function(svf.perc, plot.chems=F) {
  vol.perc <- vol[svf.perc$sample,]
  cap.perc.comb <- capscale(sqrt(vol.perc) ~ Year+DN+Temp, distance="bray", data=svf.perc)
    summ.cap <- summary(cap.perc.comb)
    prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
    ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
    anova.cap <- anova(cap.perc.comb, by="margin")
    
    plot(cap.perc.comb, type="n", xlim=range(cap.perc.comb$CCA$wa[,1]), xlab=ax.labs[1], ylab=ax.labs[2])
    title(paste("Percivals: I.",unique(svf.perc$PlantType), "2018/2019","n =", nrow(svf.perc)))
    legend("bottomleft", title=paste("Temperature","\nP =",anova.cap["Temp","Pr(>F)"]), levels(svf.perc$Temp), fill=Tempcol)
  legend("bottomright", title=paste("Time","\nP =",anova.cap["DN","Pr(>F)"]), levels(svf.perc$DN), fil=c(0,1))
  legend("topright", title=paste("Year","\nP =",anova.cap["Year","Pr(>F)"]), levels(svf.perc$Year), pch=c(19,15))
  ordispider(cap.perc.comb, with(svf.perc, paste(Year, Temp, Sample2)), col="grey80")
  points(cap.perc.comb, display="sites", col=Tempcol[svf.perc$Temp], pch=c(1,0,19,15)[factor(paste(svf.perc$DN, svf.perc$Year))]) 
  text(cap.perc.comb, display="cn")
  text(cap.perc.comb, display="species", cex=0.7, srt=45, col=ifelse(sqrt(cap.perc.comb$CCA$v[,1]^2 + cap.perc.comb$CCA$v[,2]^2)>0.2, alpha("purple",1),alpha("purple",0)))
  return(cap.perc.comb)
}
svf.perc.agg <- plot.perc.comb(svf %>% filter(expt=="perc", PlantType=="agg"))
svf.perc.ten <- plot.perc.comb(svf %>% filter(expt=="perc", PlantType=="ten"))
#svf.perc.both <- plot.perc.comb(svf %>% filter(expt=="perc"))
```

# Individual volatiles

## Treatment effects

```{r barplots, fig.width=10, fig.height=9}
vols.plot <- chemsf %>% filter(filter_final, freq.floral>0.18) %>% arrange(desc(freq.floral)) %>% pull("name") %>% as.character
#%>%union(colnames(quant.scaled.vol))
#vols.plot[vols.plot=="b-caryophyllene"] <- "b-caryophyllene.1"#c("b-ocimene","a-pinene","a-farnesene","b-caryophyllene.1","petasitene","b-myrcene","longifolene","tridec-1-ene  ","benzophenone")
vol.long <- gather(cbind(sample=rownames(vol[,vols.plot]), total=rowSums(vol), vol[,vols.plot]), key="chem",value="area", 2:(length(vols.plot)+2), factor_key=T)
vol.plot <- left_join(vol.long, svf) %>% mutate(chem=factor(chem, levels=c("total",vols.plot)))

specDNcols <- c( "#943390","#FF5056", "#A894FF","#FC8C97")
#Treatcols <- c("#DA9E18","#6B744F")
DNcols <- c("grey90","grey20")
ggplot(vol.plot %>% drop_na(PlantType, expt) %>% filter(expt=="otc", Site!="bb"),#TODO track down NAs
       aes(x=paste(Site, Year),y=area,  fill=DN, color=paste(Treat))) +
  geom_boxplot(size=0.7, outlier.size=0.7, position=position_dodge2(preserve="total")) + 
  facet_wrap(vars(chem), scales="free_y") + 
  scale_y_sqrt("Emissions (ng/flower/hr)") + 
  scale_color_brewer("Treatment", palette = "Set1", direction=-1)+
  scale_x_discrete("Site, year")+
  scale_fill_manual("Time of day",values=DNcols) + 
  theme_minimal() + theme(axis.text.x=element_text(angle=20, vjust=0.5))
```

Mean change in warming treatment relative to controls.
```{r treatmentmap, fig.width=7, fig.height=3}
vol.plot.treat <- vol.plot %>% filter(expt=="otc", Site!="bb") %>% 
  group_by(chem, PlantType, Site, Year, DN) %>% select(temp, area) %>% nest() %>% 
  mutate(model = map(data, ~ lm(area~temp, data=.x)),#TODO lmer with PlantID for 2021?
         test = map(model, ~tidy(summary(.x)))) %>% select(-data, -model) %>% unnest(test) %>% 
  mutate(relchange = estimate[2]/estimate[1],#divide warming change by intercept (mean of controls)
         ratio = (estimate[1] + estimate[2]) / estimate[1] ) %>% # warmed/control ratio 
  filter(term=="tempwarmed")

ggplot(vol.plot.treat, aes(x=paste(paste(ifelse(PlantType=="agg",Site,as.character(DN)), str_sub(Year,3,4))), 
                           y=fct_relabel(fct_rev(chem), greekify))) + 
  facet_wrap(vars(PlantType), scales="free_x", 
             labeller = as_labeller(c(agg="I. aggregata", ten="I. tenuituba")))+
  geom_tile(aes(fill=sign(relchange)* abs(relchange)^(1/3))) + scale_fill_gradient2(midpoint=0, guide="none")  + 
  geom_text(aes(label=scales::percent(relchange, accuracy=1), fontface=as.integer(p.value < 0.05)+1))+ labs(x="",y="")+
  theme_minimal() + theme(panel.grid = element_blank(), strip.text = element_text(face="italic"),
                          axis.text=element_text(color="black"))

lmer(indole~temp+(1|PlantID), data = filter(cbind(vol,svf), expt=="otc", PlantType=="ten", DN=="day")) %>% anova() %>% 
  kable(caption="indole tenuituba day")
lmer(indole~temp+(1|PlantID), data = filter(cbind(vol,svf), expt=="otc", PlantType=="ten", DN=="night")) %>% anova() %>% 
    kable(caption="indole tenuituba night")
```


## Actual temperature effects

```{r temptrend, fig.width=10, fig.height=9}
ggplot(drop_na(vol.plot, PlantType, expt) %>% filter(expt=="otc", Site!="bb"),#TODO track down NAs
       aes(x=mean_temp_C_treatment, y=area, shape=DN, color=paste(PlantType, Site, Year))) +
  geom_point() + geom_smooth(se=F, method="loess", span=1)+ 
  facet_wrap(vars(chem), scales="free_y") + 
  scale_y_sqrt("Emissions (ng/flower/hr)") + 
  scale_x_continuous("Mean temperature in controls or OTCs (\u00B0C)")+
  scale_color_brewer("Species, site, year", palette = "Dark2", direction=-1)+#scale_color_manual("Species", values=spcols) + 
  scale_shape_manual("Time of day",values=c(1,19)) + 
  theme_minimal() + theme(axis.text.x=element_text(angle=20, vjust=0.5))

vol.plot %>% filter(expt=="otc", Site!="bb") %>% drop_na(mean_temp_C_treatment) %>% 
  group_by(chem, PlantType, Site, Year, DN) %>% select(mean_temp_C_treatment, area) %>% nest() %>% 
  mutate(model = map(data, ~ lm(area~poly(mean_temp_C_treatment, 2), data=.x)),
         test = map(model, ~tidy(summary(.x)))) %>% select(-data, -model) %>% unnest(test) %>% 
  filter(term=="poly(mean_temp_C_treatment, 2)2", p.value < 0.05) %>% select(-term, -std.error, -statistic) %>% 
  arrange(p.value) %>%  kable(caption="Temperature curves with a significant quadratic term")
```

Units are change (relative to the mean) per degree Celsius
```{r temperaturemap, fig.width=7, fig.height=3}
vol.plot.temp <- vol.plot %>% filter(expt=="otc", Site!="bb") %>% drop_na(mean_temp_C_treatment) %>% 
  group_by(chem, PlantType, Site, Year, DN) %>% select(mean_temp_C_treatment, area) %>% 
  mutate(area=area/mean(area)) %>% nest() %>% 
  mutate(model = map(data, ~ lm(area~mean_temp_C_treatment, data=.x)),
         test = map(model, ~tidy(summary(.x)))) %>% select(-data, -model) %>% unnest(test) %>% 
  filter(term=="mean_temp_C_treatment")

ggplot(vol.plot.temp, aes(x=paste(ifelse(PlantType=="agg",Site,as.character(DN)), str_sub(Year,3,4)), y=fct_rev(chem))) + 
  facet_wrap(vars(PlantType), scales="free_x", 
             labeller = as_labeller(c(agg="I. aggregata", ten="I. tenuituba")))+
  geom_tile(aes(fill=estimate)) + scale_fill_gradient2(guide="none")  + 
  geom_text(aes(label=scales::percent(estimate, accuracy=1), fontface=as.integer(p.value < 0.05)+1))+ labs(x="",y="")+
  theme_minimal() + theme(panel.grid = element_blank(), strip.text = element_text(face="italic"),
                          axis.text=element_text(color="black"))
```

Separate temperature and treatment
```{r temptreatmapsep, fig.height=6.5, fig.width=6.5}
bind_rows(vol.plot.temp, vol.plot.treat) %>% mutate(relchange = coalesce(relchange,estimate)) %>% 
ggplot(aes(x=paste(ifelse(PlantType=="agg",Site,as.character(DN)), str_sub(Year,3,4)), y=fct_relabel(fct_rev(chem), greekify))) + 
  facet_grid(term ~PlantType, scales="free_x", 
             labeller = as_labeller(c(agg="I. aggregata", ten="I. tenuituba", 
                                      mean_temp_C_treatment="(A) Temperature", tempwarmed="(B) Treatment")))+
  geom_tile(aes(fill=if_else(term =="mean_temp_C_treatment", log10(relchange+1)*5,log10(relchange+1)))) + scale_fill_gradient2(guide="none", limits=c(-1,1), oob=scales::squish)  + 
  geom_text(aes(label=scales::percent(relchange, accuracy=1, big.mark=""), fontface=as.integer(p.value < 0.05)+1))+ labs(x="",y="")+
  theme_minimal() + theme(panel.grid = element_blank(), strip.text.x = element_text(face="italic"),
                          axis.text=element_text(color="black"))
```

Both temperature and treatment

```{r temptreatmap, fig.width=7, fig.height=6}
safe_lmer <- function(formula, data) {
 if(length(unique(pull(data,as.character(findbars(formula)[[1]])[3]))) < nrow(data)*(2/3)) {
   lmer(formula, data=data) #run only if there are more random effect levels than rows
 } else {
   lm(nobars(formula), data=data) #else drop the random effects and run an lm
 }
}
vol.plot.temptreat <- vol.plot %>% filter(expt=="otc", Site!="bb") %>% drop_na(mean_temp_C_treatment) %>% 
  group_by(chem, PlantType, Site, Year, DN) %>% select(temp, mean_temp_C_treatment, area, PlantID) %>% 
  mutate(area=area/mean(area), PlantID=as.character(PlantID)) %>% nest() %>% 
  mutate(coef = map(data, ~tidy(safe_lmer(area ~ temp + mean_temp_C_treatment + (1|PlantID), data=.x)))) %>% 
  select(coef) %>% unnest(coef) %>% filter(term %in% c("tempwarmed","mean_temp_C_treatment"))

ggplot(vol.plot.temptreat, aes(x=paste(ifelse(PlantType=="agg",Site,as.character(DN)), str_sub(Year,3,4)), y=fct_rev(chem))) + 
  facet_grid(term ~PlantType, scales="free_x", 
             labeller = as_labeller(c(agg="I. aggregata", ten="I. tenuituba", mean_temp_C_treatment="Temperature", tempwarmed="Treatment")))+
  geom_tile(aes(fill=estimate)) + scale_fill_gradient2(guide="none")  + 
  geom_text(aes(label=scales::percent(estimate, accuracy=1), fontface=as.integer(p.value < 0.05)+1))+ labs(x="",y="")+
  theme_minimal() + theme(panel.grid = element_blank(), strip.text = element_text(face="italic"),
                          axis.text=element_text(color="black"))

vol.plot %>% filter(expt=="otc", Site!="bb", chem=="total") %>% 
  ggplot(aes(x=mean_temp_C_treatment, y=area, color=temp)) + geom_point() +
  facet_wrap(vars(PlantType, Site,  DN, Year)) + geom_smooth(method="lm") + scale_color_brewer(palette = "Set1", direction = -1)
#TODO may need to add temp*treat interaction, since fixed slope is giving misleading conclusions
#TODO temperature range is very short in 2019 (fewer sampling days) and at night - not very informative
#TODO most of the temp variation in among sampling days, confounded if scent changes with season
#TODO no sqrt transformation, so outliers have more influence on lms
```

```{r tempvtreat}
bind_rows(treat=vol.plot.treat %>% rename(value=relchange), 
          temp=vol.plot.temp %>% rename(value=estimate), .id="variable") %>% 
  select(-term, -std.error, -statistic, -p.value, -ratio, -estimate) %>% 
  pivot_wider(names_from =variable, values_from=value) %>% 
  ggplot(aes(y=treat, x=temp, color=paste(PlantType, Site, DN, Year))) + 
  geom_hline(yintercept=0) + geom_vline(xintercept=0) +  
  geom_smooth(se=F, method="lm") +
  geom_text(aes(label=chem), show.legend = F)+
  theme_minimal() + scale_y_continuous(labels=scales::percent_format(),limits=c(NA,4)) +
  scale_x_continuous(labels=scales::percent_format()) + scale_color_brewer(palette = "Set2") +
  labs(x="Change in emissions per degree C", y="Change in emissions in warming treatment",
       color="Species, site, time, year")

vol.long.meta <- gather(cbind(sample=rownames(vol), total=rowSums(vol), vol), key="chem",value="area", 2:(ncol(vol)+2), factor_key=T) %>% left_join(svf) %>% mutate(chem=factor(chem, levels=c("total",colnames(vol))))

vol.plot.treat <- vol.long.meta %>% filter(expt=="otc", Site!="bb") %>% 
  group_by(chem, PlantType, DN) %>% select(temp, area) %>% nest() %>% 
  mutate(model = map(data, ~ lm(area~temp, data=.x)),#TODO lmer with PlantID for 2021?
         test = map(model, ~tidy(summary(.x)))) %>% select(-data, -model) %>% unnest(test) %>% 
  mutate(relchange = estimate[2]/estimate[1],#divide warming change by intercept (mean of controls)
         ratio = (estimate[1] + estimate[2]) / estimate[1] ) %>% # warmed/control ratio 
  filter(term=="tempwarmed")
vol.plot.temp <- vol.long.meta %>% filter(expt=="otc", Site!="bb") %>% drop_na(mean_temp_C_treatment) %>% 
  group_by(chem, PlantType, DN) %>% select(mean_temp_C_treatment, area) %>% 
  mutate(area=area/ifelse(mean(area)==0, 1, mean(area))) %>% nest() %>% 
  mutate(model = map(data, ~ lm(area~mean_temp_C_treatment, data=.x)),
         test = map(model, ~tidy(summary(.x)))) %>% select(-data, -model) %>% unnest(test) %>% 
  filter(term=="mean_temp_C_treatment")

vol.plot.temptreat.sep <- bind_rows(treat=vol.plot.treat %>% rename(value=relchange), 
          temp=vol.plot.temp %>% rename(value=estimate), .id="variable") %>% 
  select(-term, -std.error, -statistic, -p.value, -ratio, -estimate) %>% 
  pivot_wider(names_from =variable, values_from=value)

vol.plot.temptreat.sep %>% filter(treat <15) %>% 
ggplot(aes(y=treat, x=temp, color=paste(PlantType, DN))) + 
  geom_hline(yintercept=0) + geom_vline(xintercept=0) +  
  geom_smooth(se=F, method="lm") +
  geom_text(aes(label=chem), show.legend = F)+
  theme_minimal() + scale_y_continuous(labels=scales::percent_format()) +
  scale_x_continuous(labels=scales::percent_format()) + scale_color_brewer(palette = "Set2") +
  labs(x="Change in emissions per degree C", y="Change in emissions in warming treatment",
       color="Species, site, time, year")

vol.plot.temptreat.sep %>% filter(DN=="day") %>% 
  left_join(ipochemsf, by=join_by("chem"=="shortname")) %>% 
  ggplot(aes(y=treat, x=temp, color=class)) + 
  geom_hline(yintercept=0) + geom_vline(xintercept=0) +  
  geom_text(aes(label=chem, fontface=as.integer(PlantType)))+
  theme_minimal() + scale_y_continuous(labels=scales::percent_format()) +
  scale_x_continuous(labels=scales::percent_format()) + scale_color_manual(values=class_pal) +
  labs(x="Change in emissions per degree C", y="Change in emissions in warming treatment",
       color="Class", title="Daytime changes", subtitle="tenuituba = bold text, aggregata = not bold")

vol.plot.temptreat.sep %>% group_by(PlantType, DN)  %>%
  summarize(r=cor(temp, treat), 
            P = cor.test(temp, treat)$p.value) %>% 
  kable(caption="Correlation between treatment and temperature effects", digits=3)
```


## Soil moisture effects

```{r VWCtrend, fig.width=10, fig.height=9}
ggplot(drop_na(vol.plot, PlantType, expt) %>% filter(expt=="otc", Site!="bb"),#TODO track down NAs
       aes(x=SoilVWC, y=area, shape=DN, color=paste(PlantType, Site, Year))) +
  geom_point() + geom_smooth(se=F, method="loess", span=1)+
  facet_wrap(vars(chem), scales="free_y") + 
  scale_y_sqrt("Emissions (ng/flower/hr)") + 
  scale_x_continuous("Soil volumetric water content (%)")+
  scale_color_brewer("Species, site, year", palette = "Dark2", direction=-1)+#scale_color_manual("Species", values=spcols) + 
  scale_shape_manual("Time of day",values=c(1,19)) + 
  theme_minimal() + theme(axis.text.x=element_text(angle=20, vjust=0.5))

vol.plot %>% filter(expt=="otc", Site!="bb") %>% drop_na(SoilVWC) %>% 
  group_by(chem, PlantType, Site, Year, DN) %>% select(SoilVWC, area) %>% nest() %>% 
  mutate(model = map(data, ~ lm(area~poly(SoilVWC, 2), data=.x)),
         test = map(model, ~tidy(summary(.x)))) %>% select(-data, -model) %>% unnest(test) %>% 
  filter(term=="poly(SoilVWC, 2)2", p.value < 0.05) %>% select(-term, -std.error, -statistic) %>% 
  arrange(p.value) %>%  kable(caption="Soil moisture curves with a significant quadratic term")
```

## Day/night changes

Mean change at night relative to day.
```{r DNmap, fig.width=7, fig.height=7}
#TODO lmer(area~DN+(1|PlantID)) gives negative intercepts
vol.plot.DN <- vol.long.meta %>% filter(!(PlantType=="agg" & expt=="otc")) %>% 
  group_by(chem, expt, PlantType, Year) %>% select(DN, area, PlantID) %>% nest() %>% 
  mutate(model = map(data, ~ lm(area~DN, data=.x)),
         test = map(model, ~tidy(summary(.x)))) %>% select(-data, -model) %>% unnest(test) %>% 
  mutate(relchange = estimate[2]/estimate[1],#divide warming change by intercept (mean of controls)
         ratio = (estimate[1] + estimate[2]) / estimate[1] ) %>% # warmed/control ratio 
  filter(term=="DNnight")

ggplot(vol.plot.DN %>% filter(abs(relchange)<1000), aes(x=str_sub(Year,3,4), y=fct_rev(chem))) + 
    facet_wrap(vars(PlantType, expt), scales="free_x")+
  geom_tile(aes(fill=sign(relchange)* abs(relchange)^(1/3))) + scale_fill_gradient2(midpoint=0, guide="none")  + 
  geom_text(aes(label=scales::percent(relchange, accuracy=1), fontface=as.integer(p.value < 0.05)+1))+ labs(x="",y="")+
  theme_minimal() + theme(panel.grid = element_blank(), strip.text = element_text(face="italic"),
                          axis.text=element_text(color="black"))

vol.plot.DN <- vol.long.meta %>% filter(!(PlantType=="agg" & expt=="otc")) %>% 
  group_by(chem, expt, PlantType) %>% select(DN, area, PlantID) %>% nest() %>% 
  mutate(model = map(data, ~ lm(area~DN, data=.x)),
         test = map(model, ~tidy(summary(.x)))) %>% select(-data, -model) %>% unnest(test) %>% 
  mutate(relchange = estimate[2]/estimate[1],#divide warming change by intercept (mean of controls)
         ratio = (estimate[1] + estimate[2]) / estimate[1] ) %>% # warmed/control ratio 
  filter(term=="DNnight")

ggplot(vol.plot.DN, aes(x="N/D", y=fct_rev(chem))) + 
    facet_wrap(vars(PlantType, expt), scales="free_x")+
  geom_tile(aes(fill=sign(relchange)* abs(relchange)^(1/3))) + scale_fill_gradient2(midpoint=0, guide="none")  + 
  geom_text(aes(label=scales::percent(relchange, accuracy=1), fontface=as.integer(p.value < 0.05)+1))+ labs(x="",y="")+
  theme_minimal() + theme(panel.grid = element_blank(), strip.text = element_text(face="italic"),
                          axis.text=element_text(color="black"))
```


# Leaf volatiles

## Inventory

Dropped 2 samples from 2018 without leaf mass. Volatiles units are ng per hour per gram dry leaf.

```{r inventory_leaf}
svl %>% count(PlantType, Treat, expt, Year) %>% kable(caption="Sample size")
sort(colSums(vol.leaf)/sum(colSums(vol.leaf)) )
```

## Heatmap

```{r heatmap_leaf, dev="png", dev.args = list(), fig.height=8, fig.width=12}
#cairo_pdf("ipo_heatmap_leaf.pdf", width=12, height=12)
ph_leaf  <- pheatmap(as.matrix(t(vol.leaf))^(1/3), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol.leaf, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=inferno(512),
         annotation_col = data.frame(svl %>% select("PlantType", "expt", "Treat"), row.names=rownames(vol.leaf)), 
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
#dev.off()
```

## Leaf NMDS

```{r nmds_filtered_leaf}
set.seed(1)
nmds.vol_leaf <- metaMDS(sqrt(vol.leaf), dist="bray", autotransform = FALSE, trace=F)

TEY <- with(svl, factor(paste(PlantType,expt,Year)))
TEYcols <- brewer.pal(9, "Paired")#[c(1:4,8,5:6)]
spcols <- c(aggleaf="red", tenleaf="violet")
ordiplot(nmds.vol_leaf, type = "n")
legend("bottomleft", levels(TEY), fill=TEYcols, cex=0.9)
points(nmds.vol_leaf, display="sites", col=TEYcols[TEY], pch=19)
text(nmds.vol_leaf, display="species", cex=0.7, col="grey20")
#points(nmds.vol_leaf, display="sites", col=viridis(100)[sqrt(rowSums(vol.leaf))/26], pch=19)
```

## CAP - OTCs

```{r cap_leaf_otc}
svf.otc <- svl %>% filter(expt=="otc")
vol.otc <- vol.leaf[svl$expt=="otc",]
(cap.otc.comb <- capscale(sqrt(vol.otc) ~ PlantType + temp, distance="bray", data=svf.otc)) #can't test temp, missing data
anova(cap.otc.comb, by="margin") %>% kable(caption="CAP")
prop.expl <- summary(cap.otc.comb)$cont$importance
ax.labs <- paste0(colnames(prop.expl)[1:2], " (",round(100*prop.expl[2,1:2]),"% explained)")
cap.df <- fortify(cap.otc.comb) 
ggplot(mapping=aes(x=CAP1, y=CAP2, label=Label)) + 
  geom_point(data=cap.df %>% filter(Score=="sites") %>% bind_cols(svf.otc), aes(color=temp, shape=PlantType), size=3)+
  geom_segment(data=cap.df %>% filter(Score=="biplot", Label %in% arrowvars), aes(x=0,y=0,xend=CAP1*1.2, yend=CAP2*1.2), 
               arrow=arrow(length=unit(0.5, "lines")), color="white")+
  geom_text(data=cap.df %>% filter(Score=="biplot", Label %in% arrowvars[2]) %>% mutate(Label=names(arrowvars[2])),
            aes(x=CAP1*1.3, y=CAP2*1.3, angle=atan(CAP2/CAP1)*180/pi, hjust=1), fontface="bold", color="white", size=5) +
  geom_text(data=cap.df %>% filter(Score=="centroids") %>% mutate(Label=c("aggregata","tenuituba","","")),
            aes(x=CAP1, y=CAP2), fontface=4, color="white", size=5) +
  geom_text_repel(data=cap.df %>% left_join(ipochems, by=c("Label"="name")) %>% filter(Score=="species", sqrt(CAP1^2+CAP2^2)>0.2), 
            aes(x=CAP1*3.2, y=CAP2*3.2), size=4, color="black", point.size=NA, box.padding=0)+ 
  scale_color_manual("Treatment", values=tempcol) +  
  scale_shape_manual("Species", values=c(19,15), labels=c(expression(italic("I. aggregata")),expression(italic("I. tenuituba")))) + 
  labs(x=ax.labs[1], y=ax.labs[2])+
  coord_fixed() + theme_bw() + theme(panel.grid = element_blank(), panel.background = element_rect(fill="grey70"))

lmer(sqrt(Total) ~ PlantType + temp + (1|PlantID), data = svf.otc) %>% anova %>% kable(caption="total emissions")
```

## CAP - Percivals

```{r cap_leaf_perc}
svl.perc <- svl %>% filter(expt=="perc")
cap.leaf.perc <- capscale(sqrt(vol.leaf[svl$expt=="perc",]) ~ PlantType+Temp, distance="bray", data=svl.perc)
summ.cap <- summary(cap.leaf.perc)
prop.expl <- summ.cap$cont$importance[2,c("CAP1","CAP2")]
ax.labs <- paste0("CAP", 1:2, " (",round(100*prop.expl),"% explained)")
(anova.cap <- anova(cap.leaf.perc, by="margin"))
```

## Composition
```{r compleaf}
absamounts.leaf <- svl %>% select(expt, PlantType, DN) %>% 
  bind_cols(vol.leaf) %>% pivot_longer(all_of(colnames(vol.leaf))) %>%
  group_by(PlantType, name) %>% 
  summarize(mean=mean(value), se=sd(value)/sqrt(n())) %>% arrange(PlantType, desc(mean))

ggplot(absamounts.leaf, aes(y=fct_reorder(name, mean, base::mean), x=mean, color=PlantType))+ 
  geom_pointrange(aes(xmin=mean-se, xmax=mean+se), position=position_dodge2(width=0.4)) + scale_x_sqrt(expand=c(0,0))+ 
  labs(x="Mean nanograms per g dry mass per hour",y="",color="Species")

absamounts.leaf %>% mutate(across(all_of(c("mean", "se")), ~format(round(.x/1000, 2), nsmall = 2))) %>%
  mutate(meanse = paste(mean,"\U00B1", se), .keep="unused") %>% 
  pivot_wider(names_from=PlantType, values_from=meanse) %>% 
  kable(caption="Leaf volatiles, mean \U00B1 se milligrams per g dry mass per hour", digits=2)
```

